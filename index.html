<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PERINATAL QUEST - Plataforma de Cuidados Paliativos Perinatales</title>
    <style>
        /* Design System Variables */
        :root {
            /* Perinatal Quest Color Palette */
            --color-primary-blue: #A8D5E2;
            --color-secondary-green: #B4D7B4;
            --color-tertiary-pink: #F4C4D0;
            --color-background: #F8F9FA;
            --color-text: #2C3E50;
            --color-white: #FFFFFF;
            --color-gray-soft: #E0E7ED;
            --color-success: #28a745;
            --color-error: #dc3545;
            --color-warning: #ffc107;

            /* Typography */
            --font-family-base: 'Segoe UI', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-size-xs: 12px;
            --font-size-sm: 14px;
            --font-size-base: 16px;
            --font-size-lg: 18px;
            --font-size-xl: 20px;
            --font-size-2xl: 24px;
            --font-size-3xl: 32px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;

            /* Spacing */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            --space-10: 40px;

            /* Border Radius */
            --radius-sm: 6px;
            --radius-base: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-full: 9999px;

            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.15);

            /* Animation */
            --duration-fast: 0.15s;
            --duration-normal: 0.3s;
            --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-base);
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--space-4);
        }

        .container-sm {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 var(--space-4);
        }

        /* Typography */
        h1 {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--space-4);
        }

        h2 {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--space-3);
        }

        h3 {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--space-2);
        }

        p {
            margin-bottom: var(--space-3);
        }

        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-3) var(--space-6);
            border: none;
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            text-decoration: none;
            cursor: pointer;
            transition: all var(--duration-normal) var(--ease-standard);
            min-height: 44px;
            gap: var(--space-2);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background-color: var(--color-secondary-green);
            color: var(--color-text);
        }

        .btn-primary:hover {
            background-color: #9CC99C;
        }

        .btn-secondary {
            background-color: var(--color-primary-blue);
            color: var(--color-text);
        }

        .btn-tertiary {
            background-color: var(--color-tertiary-pink);
            color: var(--color-text);
        }

        .btn-lg {
            padding: var(--space-4) var(--space-8);
            font-size: var(--font-size-lg);
            min-height: 56px;
        }

        .btn-full {
            width: 100%;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Card Styles */
        .card {
            background-color: var(--color-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            padding: var(--space-6);
            margin-bottom: var(--space-4);
            transition: all var(--duration-normal) var(--ease-standard);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .card-body {
            padding: var(--space-6);
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--color-gray-soft);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin: var(--space-2) 0;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--color-secondary-green);
            transition: width var(--duration-normal) var(--ease-standard);
            border-radius: var(--radius-full);
        }

        /* Badge Styles */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: var(--space-1) var(--space-2);
            background-color: var(--color-gray-soft);
            color: var(--color-text);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
            gap: var(--space-1);
        }

        .badge-primary {
            background-color: var(--color-primary-blue);
        }

        .badge-success {
            background-color: var(--color-secondary-green);
        }

        .badge-pink {
            background-color: var(--color-tertiary-pink);
        }

        /* Utility Classes */
        .flex {
            display: flex;
        }

        .flex-col {
            flex-direction: column;
        }

        .items-center {
            align-items: center;
        }

        .justify-center {
            justify-content: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .text-center {
            text-align: center;
        }

        .text-left {
            text-align: left;
        }

        .text-sm {
            font-size: var(--font-size-sm);
        }

        .text-lg {
            font-size: var(--font-size-lg);
        }

        .text-xl {
            font-size: var(--font-size-xl);
        }

        .font-bold {
            font-weight: var(--font-weight-bold);
        }

        .font-semibold {
            font-weight: var(--font-weight-semibold);
        }

        .mb-4 {
            margin-bottom: var(--space-4);
        }

        .mb-6 {
            margin-bottom: var(--space-6);
        }

        .mt-4 {
            margin-top: var(--space-4);
        }

        .mt-6 {
            margin-top: var(--space-6);
        }

        .p-4 {
            padding: var(--space-4);
        }

        .p-6 {
            padding: var(--space-6);
        }

        .hidden {
            display: none !important;
        }

        .opacity-50 {
            opacity: 0.5;
        }

        .cursor-pointer {
            cursor: pointer;
        }

        .gap-2 {
            gap: var(--space-2);
        }

        .gap-4 {
            gap: var(--space-4);
        }

        /* Additional utility classes for consistency (fix missing Tailwind-like classes) */
        .btn-sm {
            padding: var(--space-2) var(--space-4);
            font-size: var(--font-size-sm);
            min-height: 36px;
        }
        .text-xs {
            font-size: var(--font-size-xs);
        }
        .text-2xl {
            font-size: var(--font-size-2xl);
        }
        .text-3xl {
            font-size: var(--font-size-3xl);
        }
        /* For larger text used in medal unlock overlay */
        .text-6xl {
            font-size: 3rem;
            line-height: 1;
        }
        .mt-1 {
            margin-top: var(--space-1);
        }
        .mt-2 {
            margin-top: var(--space-2);
        }
        .mt-3 {
            margin-top: var(--space-3);
        }
        .mb-2 {
            margin-bottom: var(--space-2);
        }
        .mr-2 {
            margin-right: var(--space-2);
        }
        .ml-5 {
            margin-left: var(--space-5);
        }
        .list-disc {
            list-style-type: disc;
            padding-left: var(--space-5);
        }
        /* Responsive grid helpers replacing md: and lg: prefixes */
        @media (min-width: 768px) {
            .grid-md-2 {
                grid-template-columns: repeat(2, 1fr);
            }
            .grid-md-3 {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (min-width: 1024px) {
            .grid-lg-3 {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Grid Layouts */
        .grid {
            display: grid;
        }

        .grid-cols-1 {
            grid-template-columns: repeat(1, 1fr);
        }

        .grid-cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .grid-cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        @media (max-width: 768px) {
            .grid-cols-2 {
                grid-template-columns: 1fr;
            }

            .grid-cols-3 {
                grid-template-columns: 1fr;
            }
        }

        /* Specific Component Styles */
        .home-header {
            background: linear-gradient(135deg, var(--color-primary-blue) 0%, var(--color-secondary-green) 100%);
            color: var(--color-text);
            padding: var(--space-10) 0;
            text-align: center;
            border-radius: var(--radius-xl);
            margin-bottom: var(--space-6);
        }

        .subtitle {
            font-style: italic;
            color: var(--color-tertiary-pink);
            font-size: var(--font-size-lg);
            margin-bottom: var(--space-6);
        }

        .level-card {
            border: 2px solid transparent;
            transition: all var(--duration-normal) var(--ease-standard);
            position: relative;
        }

        .level-card.beginner {
            border-color: var(--color-primary-blue);
            background: linear-gradient(145deg, #ffffff, #f0f8ff);
        }

        .level-card.intermediate {
            border-color: var(--color-secondary-green);
            background: linear-gradient(145deg, #ffffff, #f0fff0);
        }

        .level-card.advanced {
            border-color: var(--color-tertiary-pink);
            background: linear-gradient(145deg, #ffffff, #fff0f5);
        }

        .level-card.locked {
            opacity: 0.6;
            filter: grayscale(1);
        }

        .level-icon {
            font-size: 2.5rem;
            margin-bottom: var(--space-2);
        }

        .quiz-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .question-card {
            background: var(--color-white);
            border-radius: var(--radius-lg);
            padding: var(--space-8);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-6);
        }

        .option-button {
            width: 100%;
            text-align: left;
            padding: var(--space-4);
            margin-bottom: var(--space-2);
            background: var(--color-white);
            border: 2px solid var(--color-gray-soft);
            border-radius: var(--radius-base);
            transition: all var(--duration-fast) var(--ease-standard);
            cursor: pointer;
        }

        .option-button:hover {
            border-color: var(--color-primary-blue);
            background-color: #f0f8ff;
        }

        .option-button.selected {
            border-color: var(--color-primary-blue);
            background-color: #e6f3ff;
        }

        .option-button.correct {
            border-color: var(--color-success);
            background-color: #d4edda;
        }

        .option-button.incorrect {
            border-color: var(--color-error);
            background-color: #f8d7da;
        }

        .feedback-card {
            padding: var(--space-4);
            border-radius: var(--radius-base);
            margin-top: var(--space-4);
        }

        .feedback-correct {
            background-color: #d4edda;
            border: 1px solid var(--color-success);
            color: #155724;
        }

        .feedback-incorrect {
            background-color: #f8d7da;
            border: 1px solid var(--color-error);
            color: #721c24;
        }

        .floating-button {
            position: fixed;
            top: var(--space-4);
            right: var(--space-4);
            z-index: 1000;
            border-radius: var(--radius-full);
            box-shadow: var(--shadow-lg);
        }

        .medal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-top: var(--space-6);
        }

        .medal-card {
            text-align: center;
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            background: var(--color-white);
            box-shadow: var(--shadow-sm);
            transition: all var(--duration-normal) var(--ease-standard);
        }

        .medal-card.earned {
            background: linear-gradient(145deg, #fff3cd, #ffeaa7);
            transform: scale(1.05);
        }

        .medal-card.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .medal-icon {
            font-size: 2rem;
            margin-bottom: var(--space-2);
        }

        .points-display {
            background: linear-gradient(135deg, var(--color-secondary-green), var(--color-primary-blue));
            color: var(--color-text);
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            text-align: center;
            margin-bottom: var(--space-4);
        }

        .form-group {
            margin-bottom: var(--space-4);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-1);
            font-weight: var(--font-weight-medium);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: var(--space-3);
            border: 1px solid var(--color-gray-soft);
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            transition: border-color var(--duration-fast) var(--ease-standard);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--color-primary-blue);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .radio-group {
            display: flex;
            gap: var(--space-4);
            margin-top: var(--space-2);
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }

        .admin-section {
            background: var(--color-white);
            padding: var(--space-6);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-6);
        }

        .question-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--color-gray-soft);
            border-radius: var(--radius-base);
            padding: var(--space-4);
        }

        .question-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-2);
            border-bottom: 1px solid var(--color-gray-soft);
        }

        .question-item:last-child {
            border-bottom: none;
        }

        .clinical-mission {
            background: linear-gradient(135deg, var(--color-tertiary-pink), var(--color-primary-blue));
            color: var(--color-text);
            padding: var(--space-8);
            border-radius: var(--radius-xl);
            text-align: center;
            margin: var(--space-6) 0;
        }

        .mission-title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            margin-bottom: var(--space-4);
        }

        .scenario-text {
            background: var(--color-white);
            padding: var(--space-4);
            border-radius: var(--radius-base);
            margin: var(--space-4) 0;
            text-align: left;
            line-height: 1.6;
        }

        .decision-card {
            background: var(--color-white);
            padding: var(--space-6);
            border-radius: var(--radius-lg);
            margin: var(--space-4) 0;
            box-shadow: var(--shadow-md);
        }

        .animation-points {
            animation: pointsAnimation 1s ease-out;
        }

        @keyframes pointsAnimation {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.2);
                opacity: 0.8;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .medal-unlock {
            animation: medalUnlock 0.8s ease-out;
        }

        @keyframes medalUnlock {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 0;
            }

            60% {
                transform: scale(1.1) rotate(180deg);
                opacity: 1;
            }

            100% {
                transform: scale(1) rotate(360deg);
                opacity: 1;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 0 var(--space-2);
            }

            h1 {
                font-size: var(--font-size-2xl);
            }

            .home-header {
                padding: var(--space-6) var(--space-4);
            }

            .question-card {
                padding: var(--space-4);
            }

            .floating-button {
                top: var(--space-2);
                right: var(--space-2);
            }

            .btn {
                padding: var(--space-2) var(--space-4);
                font-size: var(--font-size-sm);
            }

            .btn-lg {
                padding: var(--space-3) var(--space-6);
                font-size: var(--font-size-base);
            }
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus styles */
        button:focus,
        .btn:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid var(--color-primary-blue);
            outline-offset: 2px;
        }
    </style>
</head>

<body>
    <div id="app">
        <div id="home-view" class="view">
            <div class="container-sm">
                <div class="home-header">
                    <h1>PERINATAL QUEST</h1>
                    <p class="subtitle">"Cuidar también es aprender"</p>
                </div>

                <div class="card text-center">
                    <h2>Formación en Cuidados Paliativos Perinatales</h2>
                    <p>Una plataforma gamificada diseñada para profesionales de la salud que buscan afianzar conocimientos teóricos y prácticos sobre cuidados paliativos perinatales y fetales.</p>
                    <p>Aprende a través de:</p>
                    <div class="flex justify-center gap-4 mb-6">
                        <span class="badge badge-primary">🍼 Conceptos básicos</span>
                        <span class="badge badge-success">🌿 Casos clínicos</span>
                        <span class="badge badge-pink">🌈 Dilemas éticos</span>
                    </div>
                    <button class="btn btn-primary btn-lg btn-full" onclick="showLevels()">
                        COMENZAR APRENDIZAJE
                    </button>
                    <button class="btn btn-secondary btn-lg btn-full mt-4" onclick="showResources()">
                        📚 VER RECURSOS
                    </button>
                </div>

                <div class="text-center mt-6">
                    <p class="text-sm">Desarrollado para la formación en Cuidados Paliativos Perinatales</p>
                    <p class="text-sm">**© 2024 Alvaro Navarro Mingorance**</p>
                </div>
            </div>
        </div>

        <div id="levels-view" class="view hidden">
            <div class="container">
                <div class="flex justify-between items-center mb-6">
                    <h2>Selecciona tu nivel</h2>
                    <button class="btn btn-tertiary floating-button" onclick="showAchievements()">
                        🏆 MIS LOGROS
                    </button>
                </div>

                <div class="points-display">
                    <h3>⭐ <span id="total-points-display">0</span> puntos</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" id="global-progress" style="width: 0%"></div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4" id="levels-container">
                    </div>

                <div class="flex justify-center gap-4 mt-6">
                    <button class="btn btn-secondary" onclick="showHome()">← INICIO</button>
                    <button class="btn btn-tertiary" onclick="showResources()">📚 RECURSOS</button>
                    <button class="btn btn-tertiary" onclick="showAdmin()">⚙️ ADMIN</button>
                </div>
            </div>
        </div>

        <div id="quiz-view" class="view hidden">
            <div class="quiz-container">
                <div class="flex justify-between items-center mb-4">
                    <button class="btn btn-secondary" onclick="exitQuiz()">← SALIR</button>
                    <div class="flex items-center gap-4">
                        <span id="question-counter">Pregunta 1 de 10</span>
                        <span id="points-display">⭐ 0 puntos</span>
                    </div>
                </div>

                <div class="flex items-center mb-4">
                    <span id="current-level-icon">🍼</span>
                    <span id="current-level-name" class="font-semibold ml-2">Principiante</span>
                    <div class="progress-bar ml-4 flex-1">
                        <div class="progress-fill" id="quiz-progress" style="width: 0%"></div>
                    </div>
                </div>

                <div class="question-card" id="question-container">
                    </div>

                <div id="feedback-container" class="hidden">
                    </div>
            </div>
        </div>

        <div id="mission-view" class="view hidden">
            <div class="container-sm">
                <div class="clinical-mission">
                    <div class="mission-title">🏥 MISIÓN CLÍNICA DESBLOQUEADA</div>
                    <p>¡Has demostrado excelencia! Ahora enfrenta un caso clínico real.</p>
                </div>

                <div id="mission-content">
                    </div>

                <div class="text-center mt-6" id="mission-complete-button" style="display: none;">
                    <button class="btn btn-primary" onclick="completeMission()">
                        CONTINUAR AL QUIZ
                    </button>
                </div>
            </div>
        </div>

        <div id="achievements-view" class="view hidden">
            <div class="container">
                <h2 class="text-center mb-6">🏆 Mis Logros</h2>

                <div class="points-display text-center">
                    <h3>⭐ <span id="achievements-points">0</span> puntos totales</h3>
                    <p>Racha actual: <span id="current-streak">0</span> preguntas correctas</p>
                </div>

                <div class="card">
                    <h3 class="mb-4">🏅 Medallas Obtenidas</h3>
                    <div class="medal-grid" id="medals-container">
                        </div>
                </div>

                <div class="card">
                    <h3 class="mb-4">📊 Estadísticas</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p><strong>Preguntas respondidas:</strong> <span id="total-answered">0</span></p>
                            <p><strong>Tasa de acierto:</strong> <span id="success-rate">0%</span></p>
                        </div>
                        <div>
                            <p><strong>Nivel actual:</strong> <span id="current-level-stats">Principiante</span></p>
                            <p><strong>Misiones completadas:</strong> <span id="missions-completed">0</span></p>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-6">
                    <button class="btn btn-primary" onclick="showLevels()">VOLVER A NIVELES</button>
                    <button id="learn-more-btn" class="btn btn-secondary ml-4" onclick="showUnlockView()">SIGUE APRENDIENDO</button>
                </div>
            </div>
        </div>

        <div id="admin-view" class="view hidden">
            <div class="container">
                <h2 class="text-center mb-6">⚙️ Panel de Administración</h2>

                <div class="admin-section">
                    <h3 class="mb-4">Añadir Nueva Pregunta</h3>
                    <form id="question-form">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="form-label">Nivel:</label>
                                <select class="form-select" id="question-level" required>
                                    <option value="beginner">Principiante</option>
                                    <option value="intermediate">Intermedio</option>
                                    <option value="advanced">Avanzado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tema:</label>
                                <select class="form-select" id="question-category" required>
                                    <option value="fundamentos">Fundamentos</option>
                                    <option value="comunicacion">Comunicación</option>
                                    <option value="etica">Ética</option>
                                    <option value="manejo_sintomas">Manejo de Síntomas</option>
                                    <option value="toma_decisiones">Toma de Decisiones</option>
                                    <option value="apoyo_familiar">Apoyo Familiar</option>
                                    <option value="casos_complejos">Casos Complejos</option>
                                    <option value="dilemas_eticos">Dilemas Éticos</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Pregunta:</label>
                            <textarea class="form-textarea" id="question-text" required placeholder="Escribe la pregunta aquí..."></textarea>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="form-label">Opción A:</label>
                                <input type="text" class="form-input" id="option-a" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Opción B:</label>
                                <input type="text" class="form-input" id="option-b" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Opción C:</label>
                                <input type="text" class="form-input" id="option-c" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Opción D:</label>
                                <input type="text" class="form-input" id="option-d" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Respuesta Correcta:</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="correct-a" name="correct-answer" value="0" required>
                                    <label for="correct-a">A</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="correct-b" name="correct-answer" value="1" required>
                                    <label for="correct-b">B</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="correct-c" name="correct-answer" value="2" required>
                                    <label for="correct-c">C</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="correct-d" name="correct-answer" value="3" required>
                                    <label for="correct-d">D</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Explicación:</label>
                            <textarea class="form-textarea" id="question-explanation" required placeholder="Explica por qué esta es la respuesta correcta..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary btn-full">AÑADIR PREGUNTA</button>
                    </form>
                </div>

                <div class="admin-section">
                    <h3 class="mb-4">Preguntas Existentes</h3>
                    <div class="question-list" id="questions-list">
                        </div>
                </div>

                <div class="text-center mt-6">
                    <button class="btn btn-secondary" onclick="showLevels()">VOLVER AL JUEGO</button>
                </div>
            </div>
        </div>

        <div id="resources-view" class="view hidden">
            <div class="container">
                <h2 class="text-center mb-6">📚 Recursos Docentes</h2>

                <div class="card">
                    <h3 class="mb-4">⚡ Protocolos y Guías</h3>
                    <div class="card" style="border: 2px solid var(--color-primary-blue);">
                        <h4>📋 Protocolo Rápido: Manejo Dolor y Disnea en Sala de Partos</h4>
                        <p class="text-sm">Guía práctica para manejo de síntomas en cuidados paliativos perinatales</p>
                        <button class="btn btn-primary btn-sm mt-2" onclick="showProtocol()">Ver Protocolo</button>
                    </div>
                </div>

                <div class="card">
                    <h3 class="mb-4">🧠 Cuaderno NotebookLM</h3>
                    <p class="text-sm">Accede a un cuaderno interactivo con material adicional y notas clínicas.</p>
                    <a href="https://notebooklm.google.com/notebook/86d8cc24-45d7-44de-85e9-e4c40107e4eb" target="_blank" class="btn btn-primary btn-lg">Abrir NotebookLM</a>
                </div>
                <div class="card">
                    <h3 class="mb-4">📄 Documentación de Referencia</h3>
                    <div class="grid grid-cols-1 grid-md-2 grid-lg-3 gap-3">
                        <div class="card" style="border: 1px solid var(--color-gray-soft);">
                            <h5>📄 BAPM & APPM 2024: Recognising Uncertainty</h5>
                            <p class="text-sm">Framework integrado para cuidados paliativos en medicina perinatal</p>
                            <a href="https://hubble-live-assets.s3.eu-west-1.amazonaws.com/bapm/file_asset/file/2780/Palliative_care_FINAL_July24.pdf" target="_blank" class="btn btn-sm btn-secondary">Abrir PDF</a>
                        </div>
                        <div class="card" style="border: 1px solid var(--color-gray-soft);">
                            <h5>📄 ACOG 2019: Perinatal Palliative Care</h5>
                            <p class="text-sm">Committee Opinion No. 786 sobre cuidados paliativos perinatales</p>
                            <a href="https://www.acog.org/-/media/project/acog/acogorg/clinical/files/committee-opinion/articles/2019/09/perinatal-palliative-care.pdf" target="_blank" class="btn btn-sm btn-secondary">Abrir PDF</a>
                        </div>
                        <div class="card" style="border: 1px solid var(--color-gray-soft);">
                            <h5>📄 Together for Short Lives 2017</h5>
                            <p class="text-sm">Perinatal Pathway for Babies with Palliative Care Needs (2ª ed.)</p>
                            <a href="https://www.togetherforshortlives.org.uk/app/uploads/2018/01/ProRes-Perinatal-Pathway-for-Babies-With-Palliative-Care-Needs.pdf" target="_blank" class="btn btn-sm btn-secondary">Abrir PDF</a>
                        </div>
                        <div class="card" style="border: 1px solid var(--color-gray-soft);">
                            <h5>📄 SEN 2022: Recomendaciones CPP</h5>
                            <p class="text-sm">Recomendaciones de la Sociedad Española de Neonatología</p>
                            <a href="https://www.seneo.es/images/site/publicaciones/S1695403321003787.pdf" target="_blank" class="btn btn-sm btn-secondary">Abrir PDF</a>
                        </div>
                        <div class="card" style="border: 1px solid var(--color-gray-soft);">
                            <h5>📄 BMJ 2021: Perinatal PC Pathway UK</h5>
                            <p class="text-sm">Neonatal and perinatal palliative care pathway (tertiary unit)</p>
                            <a href="https://bmjpaedsopen.bmj.com/content/bmjpo/5/1/e000820.full.pdf" target="_blank" class="btn btn-sm btn-secondary">Abrir PDF</a>
                        </div>
                        <div class="card" style="border: 1px solid var(--color-gray-soft);">
                            <h5>📄 Integrative Review 2023: Components of PPC</h5>
                            <p class="text-sm">Dombrecht et al. – componentes de programas de CPP</p>
                            <a href="https://researchportal.vub.be/files/96035882/2023_DombrechtL_Children.pdf" target="_blank" class="btn btn-sm btn-secondary">Abrir PDF</a>
                        </div>
                        <div class="card" style="border: 1px solid var(--color-gray-soft);">
                            <h5>📄 ADC 2024: Integrated Framework (Wilkinson et al.)</h5>
                            <p class="text-sm">Framework publicado en Arch Dis Child Fetal Neonatal Ed</p>
                            <a href="https://smartcms.boldapps.pt/publicfiles/Uploads/Files/91/SubContent/2b8bdb7e-7d80-4366-9948-954214a852d6.pdf" target="_blank" class="btn btn-sm btn-secondary">Abrir PDF</a>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="mb-4">📚 Bibliografía</h3>
                    <ul class="list-disc ml-5 text-sm">
                        <li>BAPM & APPM. <em>Recognising uncertainty: An integrated framework for palliative care in perinatal medicine.</em> Arch Dis Child Fetal Neonatal Ed. 2024.</li>
                        <li>American College of Obstetricians and Gynecologists. <em>Perinatal Palliative Care.</em> Committee Opinion No. 786. 2019.</li>
                        <li>Together for Short Lives. <em>Perinatal Pathway for Babies with Palliative Care Needs.</em> 2ª ed., 2017.</li>
                        <li>Sociedad Española de Neonatología. <em>Recomendaciones en cuidados paliativos perinatales.</em> 2022.</li>
                        <li>Magowan J, Lawton S, et al. <em>Neonatal and perinatal palliative care pathway: A tertiary unit approach.</em> BMJ Paediatrics Open. 2021.</li>
                        <li>Dombrecht L, et al. <em>Components of perinatal palliative care: An integrative review.</em> Children. 2023.</li>
                        <li>Wilkinson D, Bertaud S, Mancini A, Murdoch E, BAPM Working Group. <em>An integrated framework for palliative care in perinatal medicine.</em> 2024.</li>
                    </ul>
                </div>
                <div class="card">
                    <h3 class="mb-4">📊 Escalas de Evaluación</h3>
                    <div class="grid grid-cols-1 grid-md-3 gap-4">
                        <div>
                            <h5 class="mb-2">NIPS (Neonatal Infant Pain Scale)</h5>
                            <img src="nips_scale.png" alt="NIPS Scale" style="width:100%; height:auto; border-radius: var(--radius-base); box-shadow: var(--shadow-sm);">
                            <a href="https://efisiopediatric.com/wp-content/uploads/2017/08/NIPS-Assessment-Tool.pdf" target="_blank" class="btn btn-sm btn-secondary mt-2">Ver PDF</a>
                        </div>
                        <div>
                            <h5 class="mb-2">PIPP (Premature Infant Pain Profile)</h5>
                            <img src="pipp_scale.png" alt="PIPP Scale" style="width:100%; height:auto; border-radius: var(--radius-base); box-shadow: var(--shadow-sm);">
                            <a href="https://meetinstrumentenzorg.nl/wp-content/uploads/instrumenten/PIPP-meetinstr.pdf" target="_blank" class="btn btn-sm btn-secondary mt-2">Ver PDF</a>
                        </div>
                        <div>
                            <h5 class="mb-2">CRIES Scale</h5>
                            <img src="cries_scale.png" alt="CRIES Scale" style="width:100%; height:auto; border-radius: var(--radius-base); box-shadow: var(--shadow-sm);">
                            <a href="https://pami.emergency.med.jax.ufl.edu/wordpress/files/2019/10/cries-scale.pdf" target="_blank" class="btn btn-sm btn-secondary mt-2">Ver PDF</a>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="mb-4">🔗 Enlaces de Interés</h3>
                    <div class="grid grid-cols-1 grid-md-2 gap-4">
                        <div>
                            <h5>Together for Short Lives</h5>
                            <p class="text-sm">Organización líder en cuidados paliativos pediátricos</p>
                            <a href="https://www.togetherforshortlives.org.uk/" target="_blank" class="btn btn-sm btn-secondary mt-1">Visitar Sitio</a>
                        </div>
                        <div>
                            <h5>APPM</h5>
                            <p class="text-sm">Association for Paediatric Palliative Medicine</p>
                            <a href="https://www.appm.org.uk/" target="_blank" class="btn btn-sm btn-secondary mt-1">Visitar Sitio</a>
                        </div>
                        <div>
                            <h5>BAPM</h5>
                            <p class="text-sm">British Association of Perinatal Medicine</p>
                            <a href="https://www.bapm.org/" target="_blank" class="btn btn-sm btn-secondary mt-1">Visitar Sitio</a>
                        </div>
                        <div>
                            <h5>AEP - Cuidados Paliativos</h5>
                            <p class="text-sm">Sección de Cuidados Paliativos de la Asociación Española de Pediatría</p>
                            <a href="https://www.aeped.es/" target="_blank" class="btn btn-sm btn-secondary mt-1">Visitar Sitio</a>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-6">
                    <button class="btn btn-primary" onclick="showLevels()">VOLVER A NIVELES</button>
                    <button class="btn btn-secondary ml-4" onclick="showHome()">INICIO</button>
                </div>
            </div>
        </div>

        <div id="protocol-modal" class="hidden" style="display: none; background: rgba(0,0,0,0.8); position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999; align-items: center; justify-content: center;">
            <div class="container-sm" style="background: white; border-radius: 1rem; padding: 2rem; max-height: 80vh; overflow-y: auto;">
                <div class="flex justify-between items-center mb-4">
                    <h2>📋 Protocolo: Manejo Dolor y Disnea</h2>
                    <button class="btn btn-secondary" onclick="closeProtocol(); return false;">✕ Cerrar</button>
                </div>
                <div id="protocol-content">
                    <div style="background: linear-gradient(135deg, #A8D5E2, #B4D7B4); padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem; text-align: center;">
                        <h3 style="color: #2C3E50; margin-bottom: 0.5rem;">⚡ PROTOCOLO RÁPIDO</h3>
                        <p style="margin: 0;">Manejo de Dolor y Disnea en Sala de Partos - Cuidados Paliativos Perinatales</p>
                    </div>

                    <div class="card" style="background: #f0f8ff;">
                        <h3 style="color: #2C3E50;">🔍 EVALUACIÓN INICIAL</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div>
                                <h4 style="color: #A8D5E2;">💊 Signos de Dolor en Neonatos</h4>
                                <ul style="margin-left: 1.5rem;">
                                    <li>Expresión facial (ceño fruncido, ojos apretados)</li>
                                    <li>Llanto agudo o quejido</li>
                                    <li>Rigidez corporal o movimientos desorganizados</li>
                                    <li>Cambios en FC/FR</li>
                                    <li><strong>Escalas:</strong> NIPS, PIPP, CRIES</li>
                                </ul>
                            </div>
                            <div>
                                <h4 style="color: #B4D7B4;">🫁 Signos de Disnea</h4>
                                <ul style="margin-left: 1.5rem;">
                                    <li>Taquipnea &gt;60 rpm o bradipnea</li>
                                    <li>Tiraje intercostal o subcostal</li>
                                    <li>Aleteo nasal</li>
                                    <li>Quejido espiratorio</li>
                                    <li>Cianosis central/periférica</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="background: #f0fff0; margin-top: 1rem;">
                        <h3 style="color: #2C3E50;">💊 MANEJO DEL DOLOR (Escalera Analgésica)</h3>

                        <div style="background: white; padding: 1rem; margin: 0.5rem 0; border-left: 4px solid #90EE90; border-radius: 0.25rem;">
                            <h4 style="color: #28a745; margin-bottom: 0.5rem;">📊 NIVEL 1 - Dolor Leve</h4>
                            <ul style="margin-left: 1.5rem;">
                                <li><strong>Sacarosa 24%:</strong> 0.5-1 mL vía oral</li>
                                <li><strong>Paracetamol:</strong> 10-15 mg/kg cada 6-8h (máx 60 mg/kg/día)</li>
                                <li><strong>Medidas no farmacológicas:</strong> Piel con piel, succión no nutritiva</li>
                            </ul>
                        </div>

                        <div style="background: white; padding: 1rem; margin: 0.5rem 0; border-left: 4px solid #FFD700; border-radius: 0.25rem;">
                            <h4 style="color: #ffc107; margin-bottom: 0.5rem;">📊 NIVEL 2 - Dolor Moderado</h4>
                            <ul style="margin-left: 1.5rem;">
                                <li><strong>Morfina IV/SC:</strong> 0.05-0.1 mg/kg en bolo</li>
                                <li><strong>Perfusión continua:</strong> 10-20 mcg/kg/hora</li>
                                <li><strong>Rescates:</strong> 10-20% de dosis/hora cada 15-30 min</li>
                            </ul>
                        </div>

                        <div style="background: white; padding: 1rem; margin: 0.5rem 0; border-left: 4px solid #dc3545; border-radius: 0.25rem;">
                            <h4 style="color: #dc3545; margin-bottom: 0.5rem;">📊 NIVEL 3 - Dolor Severo/Refractario</h4>
                            <ul style="margin-left: 1.5rem;">
                                <li><strong>Morfina:</strong> Titular perfusión 20-40 mcg/kg/hora</li>
                                <li><strong>Fentanilo:</strong> Alternativa 1-5 mcg/kg/hora</li>
                                <li><strong>Considerar:</strong> Adyuvantes (midazolam, ketamina)</li>
                            </ul>
                        </div>
                    </div>
                    <div class="card" style="background: #fff0f5; margin-top: 1rem;">
                        <h3 style="color: #2C3E50;">🫁 MANEJO DE LA DISNEA</h3>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div>
                                <h4 style="color: #F4C4D0;">🤲 Medidas No Farmacológicas</h4>
                                <ul style="margin-left: 1.5rem;">
                                    <li>Posición semi-incorporada (30-45°)</li>
                                    <li>Ambiente tranquilo y fresco</li>
                                    <li>Contacto piel con piel</li>
                                    <li>Aspiración suave de secreciones (si precisa)</li>
                                    <li>Ventilador suave o aire fresco</li>
                                </ul>
                            </div>
                            <div>
                                <h4 style="color: #A8D5E2;">💊 Medidas Farmacológicas</h4>
                                <ul style="margin-left: 1.5rem;">
                                    <li><strong>O₂ suplementario:</strong> Para CONFORT (no guiarse por cifras)</li>
                                    <li><strong>Morfina:</strong> 0.05 mg/kg cada 4h SC/IV</li>
                                    <li><strong>Midazolam:</strong> Si ansiedad asociada (0.05-0.1 mg/kg)</li>
                                    <li><strong>Escopolamina:</strong> Si estertores (10 mcg/kg cada 6h)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, #FFD700, #FFA500); padding: 1.5rem; border-radius: 0.5rem; margin-top: 1.5rem;">
                        <h3 style="text-align: center; color: #2C3E50; margin-bottom: 1rem;">⭐ PRINCIPIOS CLAVE DEL MANEJO</h3>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; text-align: center;">
                            <div style="background: white; padding: 1rem; border-radius: 0.5rem;">
                                <div style="font-size: 2rem;">🔮</div>
                                <strong>ANTICIPAR</strong>
                            </div>
                            <div style="background: white; padding: 1rem; border-radius: 0.5rem;">
                                <div style="font-size: 2rem;">📏</div>
                                <strong>EVALUAR</strong><br /><small>(escalas)</small>
                            </div>
                            <div style="background: white; padding: 1rem; border-radius: 0.5rem;">
                                <div style="font-size: 2rem;">📈</div>
                                <strong>ESCALAR</strong>
                            </div>
                            <div style="background: white; padding: 1rem; border-radius: 0.5rem;">
                                <div style="font-size: 2rem;">🎯</div>
                                <strong>TITULAR</strong>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; text-align: center; margin-top: 1rem;">
                            <div style="background: white; padding: 1rem; border-radius: 0.5rem;">
                                <div style="font-size: 2rem;">💬</div>
                                <strong>COMUNICAR</strong>
                            </div>
                            <div style="background: white; padding: 1rem; border-radius: 0.5rem;">
                                <div style="font-size: 2rem;">🔄</div>
                                <strong>REEVALUAR</strong>
                            </div>
                            <div style="background: white; padding: 1rem; border-radius: 0.5rem;">
                                <div style="font-size: 2rem;">❤️</div>
                                <strong>CONFORT PRIMERO</strong>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="background: #f8f9fa; margin-top: 1rem;">
                        <h4 style="color: #2C3E50;">⚠️ Recordatorios Importantes</h4>
                        <ul style="margin-left: 1.5rem;">
                            <li>El objetivo es el <strong>CONFORT</strong>, no normalizar constantes</li>
                            <li>Reevaluar frecuentemente con escalas validadas</li>
                            <li>Comunicación continua con la familia</li>
                            <li>Documentar todas las intervenciones y respuestas</li>
                            <li>Trabajo en equipo multidisciplinar</li>
                        </ul>
                    </div>
                </div>
                <div class="text-center mt-4">
                    <button class="btn btn-primary" onclick="downloadProtocol()">📥 Simular Descarga PDF</button>
                </div>
            </div>
        </div>

        <div id="summary-view" class="view hidden">
            <div class="container-sm">
                <h2 class="text-center mb-6">📚 Resumen de tu Sesión</h2>

                <div class="card" id="session-summary">
                    </div>

                <div class="card">
                    <h3 class="mb-4">📖 Recursos Recomendados</h3>
                    <ul>
                        <li><a href="#" target="_blank">Guía BAPM sobre Cuidados Paliativos Perinatales</a></li>
                        <li><a href="#" target="_blank">Protocolo SEN de Atención Perinatal</a></li>
                        <li><a href="#" target="_blank">Manual de Comunicación en CPP</a></li>
                        <li><a href="#" target="_blank">Guía de Duelo Perinatal</a></li>
                    </ul>
                </div>

                <div class="text-center mt-6">
                    <button class="btn btn-primary" onclick="practiceWeakAreas()">PRACTICAR TEMAS DÉBILES</button>
                    <button class="btn btn-secondary ml-4" onclick="showLevels()">CONTINUAR CON NIVELES</button>
                </div>
            </div>
        </div>

        <div id="unlock-view" class="view hidden">
            <div class="container-sm">
                <h2 class="text-center mb-6">🔓 Desbloquear Medallas</h2>
                <div id="unlock-options" class="grid grid-cols-2 gap-4">
                    </div>
                <div class="text-center mt-6">
                    <button class="btn btn-secondary" onclick="showAchievements()">VOLVER A LOGROS</button>
                </div>
            </div>
        </div>
        <div id="unlock-quiz-view" class="view hidden">
            <div class="container-sm">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="unlock-quiz-title">Quiz de Desbloqueo</h3>
                    <button class="btn btn-secondary" onclick="exitUnlockQuiz()">Salir</button>
                </div>
                <div id="unlock-question-container"></div>
                <div id="unlock-feedback-container" class="mt-4 hidden"></div>
                <div class="mt-4 flex justify-between items-center">
                    <div class="progress-bar" style="width: 80%;">
                        <div id="unlock-quiz-progress" class="progress-fill" style="width: 0%;"></div>
                    </div>
                    <div id="unlock-quiz-counter"></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Enhanced Application State - IMPORTANTE: Siempre iniciar en HOME
        let gameState = {
            currentView: 'home', // CRÍTICO: Iniciar siempre en home
            user: {
                totalPoints: 0,
                currentStreak: 0,
                medals: [],
                levelsUnlocked: [1],
                progress: {
                    beginner: {
                        correct: 0,
                        total: 0,
                        percentage: 0
                    },
                    intermediate: {
                        correct: 0,
                        total: 0,
                        percentage: 0
                    },
                    advanced: {
                        correct: 0,
                        total: 0,
                        percentage: 0
                    }
                },
                answeredQuestions: [], // Now includes IDs to prevent repetition
                completedMissions: [], // Track completed mission IDs
                missionAspectProgress: {} // Track progress in mission aspects
            },
            currentLevel: null,
            currentQuestionIndex: 0,
            currentQuestions: [],
            sessionErrors: [],
            missionUnlocked: false,
            currentMission: null,
            currentMissionQuestionIndex: 0,
            missionAnswers: [],
            // Modo de desbloqueo de medallas
            unlockMode: false,
            unlockMedal: null,
            unlockQuestions: [],
            unlockQuestionIndex: 0,
            unlockCorrectCount: 0,
            // Umbral de aprobación para desbloquear medallas (puntuación mínima)
            unlockThreshold: 4
        };

        // Complete Questions Data (45 questions total - 15 per level)
        const questionsData = {
            beginner: [{
                id: "b_fund_1",
                question: "¿Qué son los cuidados paliativos perinatales?",
                options: [
                    "Cuidados exclusivos para el final de la vida",
                    "Un enfoque activo y total desde el diagnóstico hasta el fallecimiento y el duelo",
                    "Solo control del dolor",
                    "Tratamiento únicamente curativo"
                ],
                correct: 1,
                explanation: "Los CPP son un enfoque activo y total desde el diagnóstico, durante la vida del bebé, muerte y duelo, abordando aspectos físicos, psicológicos, sociales y espirituales.",
                category: "fundamentos"
            }, {
                id: "b_fund_2",
                question: "¿Cuándo deben iniciarse los cuidados paliativos perinatales?",
                options: [
                    "Solo cuando el bebé está muriendo",
                    "Después del nacimiento",
                    "Desde el momento del diagnóstico (incluso prenatal)",
                    "Una semana antes de la muerte"
                ],
                correct: 2,
                explanation: "Los CPP comienzan desde el momento del diagnóstico de una condición limitante de la vida, que puede ser incluso durante el embarazo.",
                category: "fundamentos"
            }, {
                id: "b_fund_3",
                question: "¿Cuál es el objetivo principal de los CPP según la OMS?",
                options: [
                    "Prolongar la vida a toda costa",
                    "Mejorar la calidad de vida mediante prevención y alivio del sufrimiento",
                    "Solo tratar el dolor físico",
                    "Evitar intervenciones médicas"
                ],
                correct: 1,
                explanation: "Los CPP buscan mejorar la calidad de vida del paciente y familia mediante identificación temprana, evaluación correcta y tratamiento del dolor y otros problemas.",
                category: "fundamentos"
            }, {
                id: "b_com_1",
                question: "¿Cuál es el principio fundamental al comunicar malas noticias?",
                options: [
                    "Ser rápido y conciso",
                    "Usar terminología médica compleja",
                    "Honestidad, sensibilidad y respeto, en privacidad",
                    "Evitar hablar de la muerte"
                ],
                correct: 2,
                explanation: "La comunicación debe ser honesta, sensible y respetuosa, en ambiente privado, dando tiempo a los padres para asimilar la información.",
                category: "comunicacion"
            }, {
                id: "b_com_2",
                question: "¿Qué protocolo se recomienda para dar malas noticias?",
                options: [
                    "SPIKES (Setting, Perception, Invitation, Knowledge, Empathy, Strategy)",
                    "ABC (Airway, Breathing, Circulation)",
                    "FAST (Face, Arms, Speech, Time)",
                    "SAMPLE"
                ],
                correct: 0,
                explanation: "El protocolo SPIKES es ampliamente recomendado para comunicar malas noticias de forma estructurada y empática.",
                category: "comunicacion"
            }, {
                id: "b_com_3",
                question: "Al comunicar incertidumbre pronóstica, ¿qué es lo más importante?",
                options: [
                    "Ocultar la incertidumbre",
                    "Reconocer abiertamente la incertidumbre y preparar para diferentes escenarios",
                    "Dar siempre el peor escenario",
                    "Prometer resultados positivos"
                ],
                correct: 1,
                explanation: "Es fundamental reconocer y comunicar la incertidumbre cuando existe, preparando a la familia para múltiples posibles trayectorias.",
                category: "comunicacion"
            }, {
                id: "b_com_4",
                question: "¿Qué debe incluir una conversación inicial sobre CPP?",
                options: [
                    "Solo información médica",
                    "Diagnóstico, pronóstico, opciones y valores familiares",
                    "Únicamente los costos",
                    "Solo fecha probable de fallecimiento"
                ],
                correct: 1,
                explanation: "Las conversaciones deben ser holísticas: información médica, opciones, exploración de valores, esperanzas y miedos de la familia.",
                category: "comunicacion"
            }, {
                id: "b_etic_1",
                question: "¿Quién debe ser el centro de la toma de decisiones?",
                options: [
                    "El equipo médico exclusivamente",
                    "Los padres como socios del equipo multidisciplinar",
                    "Solo el neonatólogo",
                    "La administración del hospital"
                ],
                correct: 1,
                explanation: "Los padres deben ser reconocidos como socios activos en la toma de decisiones compartida.",
                category: "etica"
            }, {
                id: "b_etic_2",
                question: "¿Qué modelo de toma de decisiones se recomienda?",
                options: [
                    "Paternalista (médico decide)",
                    "Informativo (padres deciden solos)",
                    "Toma de decisiones compartida",
                    "Por sorteo"
                ],
                correct: 2,
                explanation: "Se recomienda toma de decisiones compartida: equipo aporta experiencia médica, padres sus valores.",
                category: "etica"
            }, {
                id: "b_etic_3",
                question: "¿Es ético ofrecer CPP junto con tratamiento curativo?",
                options: [
                    "No, son mutuamente excluyentes",
                    "Sí, el modelo de cuidado paralelo lo permite",
                    "Solo en casos terminales",
                    "Nunca"
                ],
                correct: 1,
                explanation: "El modelo paralelo permite ofrecer CPP simultáneamente con tratamientos curativos, reconociendo la incertidumbre.",
                category: "etica"
            }, {
                id: "b_etic_4",
                question: "¿Cuál es un principio ético fundamental en CPP?",
                options: [
                    "Beneficencia: actuar en el mejor interés del bebé y familia",
                    "Minimizar costos",
                    "Evitar conversaciones difíciles",
                    "Seguir protocolos rígidos"
                ],
                correct: 0,
                explanation: "La beneficencia junto con autonomía, no maleficencia y justicia son principios éticos fundamentales.",
                category: "etica"
            }, {
                id: "b_duel_1",
                question: "¿Cuándo debe comenzar el apoyo al duelo?",
                options: [
                    "Solo después del fallecimiento",
                    "Desde el diagnóstico (duelo anticipatorio)",
                    "Una semana después",
                    "Cuando los padres lo soliciten"
                ],
                correct: 1,
                explanation: "El apoyo debe comenzar desde el diagnóstico, reconociendo el duelo anticipatorio.",
                category: "duelo"
            }, {
                id: "b_duel_2",
                question: "¿Qué es importante ofrecer para crear recuerdos?",
                options: [
                    "Solo fotografías",
                    "Fotografías, huellas, mechón de pelo, objetos personales",
                    "Nada, es doloroso",
                    "Solo documentos médicos"
                ],
                correct: 1,
                explanation: "Facilitar múltiples formas de crear recuerdos es muy valorado por las familias.",
                category: "duelo"
            }, {
                id: "b_duel_3",
                question: "¿Qué papel tienen los hermanos?",
                options: [
                    "Deben ser excluidos",
                    "Pueden participar según edad, con apoyo apropiado",
                    "Solo saber después",
                    "No son importantes"
                ],
                correct: 1,
                explanation: "Los hermanos pueden ser incluidos apropiadamente con apoyo específico.",
                category: "duelo"
            }, {
                id: "b_duel_4",
                question: "¿Qué es el duelo anticipatorio?",
                options: [
                    "El duelo tras la muerte",
                    "El duelo ante un diagnóstico limitante, antes de la pérdida",
                    "El duelo de profesionales",
                    "El duelo patológico"
                ],
                correct: 1,
                explanation: "Duelo anticipatorio comienza al conocer diagnóstico limitante, permitiendo preparación.",
                category: "duelo"
            }],
            intermediate: [{
                id: "i_sint_1",
                question: "¿Elementos clave del manejo del dolor en neonatos?",
                options: [
                    "Solo farmacológicas",
                    "Escalas validadas + medidas farmacológicas y no farmacológicas",
                    "Esperar llanto",
                    "Solo paracetamol"
                ],
                correct: 1,
                explanation: "Requiere monitorización con escalas (NIPS, PIPP) y combinación de medidas.",
                category: "manejo_sintomas"
            }, {
                id: "i_sint_2",
                question: "¿Qué síntomas además del dolor evaluar?",
                options: [
                    "Solo llanto",
                    "Disnea, agitación, convulsiones, intolerancia alimentaria",
                    "Solo fiebre",
                    "No hay otros"
                ],
                correct: 1,
                explanation: "Múltiples síntomas requieren evaluación y manejo.",
                category: "manejo_sintomas"
            }, {
                id: "i_sint_3",
                question: "¿Medidas no farmacológicas efectivas?",
                options: [
                    "Ignorar bebé",
                    "Piel con piel, sacarosa, succión no nutritiva, envolver",
                    "Solo música",
                    "Mantener solo"
                ],
                correct: 1,
                explanation: "Múltiples medidas no farmacológicas son efectivas.",
                category: "manejo_sintomas"
            }, {
                id: "i_sint_4",
                question: "¿Opioide de primera línea en neonatos?",
                options: [
                    "Codeína",
                    "Morfina",
                    "Tramadol",
                    "Meperidina"
                ],
                correct: 1,
                explanation: "Morfina es el opioide de elección con dosificación cuidadosa.",
                category: "manejo_sintomas"
            }, {
                id: "i_deci_1",
                question: "¿Qué es la planificación paralela?",
                options: [
                    "Dos equipos simultáneos",
                    "Planificar para vida y deterioro/muerte simultáneamente",
                    "Dos planes de parto",
                    "Dos hospitales"
                ],
                correct: 1,
                explanation: "Planificación paralela prepara para diferentes escenarios posibles.",
                category: "toma_decisiones"
            }, {
                id: "i_deci_2",
                question: "¿Qué incluir en plan de cuidados avanzados?",
                options: [
                    "Solo reanimación",
                    "Resucitación, síntomas, lugar de cuidado, contactos",
                    "Solo hospital",
                    "Solo administrativo"
                ],
                correct: 1,
                explanation: "ACP documenta múltiples preferencias y se revisa regularmente.",
                category: "toma_decisiones"
            }, {
                id: "i_deci_3",
                question: "¿Cuándo revisar plan de cuidados avanzados?",
                options: [
                    "Nunca",
                    "Solo al alta",
                    "Regularmente y ante cambios",
                    "Una vez al año"
                ],
                correct: 2,
                explanation: "ACPs se revisan regularmente y ante cambios clínicos o preferencias.",
                category: "toma_decisiones"
            }, {
                id: "i_deci_4",
                question: "¿Qué hacer ante desacuerdo familia-equipo?",
                options: [
                    "Imponer decisión médica",
                    "Dar tiempo, deliberación, mediación, segunda opinión",
                    "Abandonar",
                    "Llamar seguridad"
                ],
                correct: 1,
                explanation: "Requiere tiempo, deliberación ética, mediación y segunda opinión.",
                category: "toma_decisiones"
            }, {
                id: "i_fam_1",
                question: "¿Aspectos esenciales del apoyo familiar?",
                options: [
                    "Solo médico",
                    "Emocional, psicológico, social, espiritual, práctico",
                    "Solo económico",
                    "Solo información"
                ],
                correct: 1,
                explanation: "Apoyo debe ser holístico en todas las dimensiones.",
                category: "apoyo_familiar"
            }, {
                id: "i_fam_2",
                question: "¿Qué es Family Integrated Care?",
                options: [
                    "Visitas limitadas",
                    "Empoderar padres a participar activamente en cuidado",
                    "Solo telefónicas",
                    "Excluir familia"
                ],
                correct: 1,
                explanation: "FICare empodera a padres para ser parte central del cuidado.",
                category: "apoyo_familiar"
            }, {
                id: "i_fam_3",
                question: "¿Cómo abordar apoyo a hermanos?",
                options: [
                    "Excluirlos",
                    "Información apropiada edad, inclusión, actividades apoyo",
                    "Solo decir que bebé enfermo",
                    "Ignorar necesidades"
                ],
                correct: 1,
                explanation: "Hermanos necesitan información apropiada, participación opcional y apoyo especializado.",
                category: "apoyo_familiar"
            }, {
                id: "i_fam_4",
                question: "¿Papel del apoyo espiritual/cultural?",
                options: [
                    "Opcional e irrelevante",
                    "Adaptar a valores, rituales y creencias de cada familia",
                    "Solo familias religiosas",
                    "No ofrecer"
                ],
                correct: 1,
                explanation: "Apoyo espiritual debe individualizarse, respetando creencias y facilitando rituales.",
                category: "apoyo_familiar"
            }, {
                id: "i_coord_1",
                question: "¿Profesionales que integran equipo CPP?",
                options: [
                    "Solo médicos",
                    "Multidisciplinar: médicos, enfermería, trabajo social, psicología, capellanía, farmacia",
                    "Solo enfermería",
                    "Un único profesional"
                ],
                correct: 1,
                explanation: "Requiere equipo multidisciplinar amplio.",
                category: "coordinacion"
            }, {
                id: "i_coord_2",
                question: "¿Qué es un coordinador de cuidados?",
                options: [
                    "Administrador",
                    "Punto de contacto fijo que guía a familia",
                    "Director hospital",
                    "Secretario"
                ],
                correct: 1,
                explanation: "Coordinador es punto de contacto consistente para familia.",
                category: "coordinacion"
            }, {
                id: "i_coord_3",
                question: "¿Qué documentar en historia clínica?",
                options: [
                    "Solo datos médicos",
                    "Conversaciones, decisiones, preferencias, planes",
                    "Solo medicaciones",
                    "Solo laboratorio"
                ],
                correct: 1,
                explanation: "Fundamental documentar conversaciones y decisiones para continuidad.",
                category: "coordinacion"
            }],
            advanced: [{
                id: "a_caso_1",
                question: "Bebé 23 semanas RCIU, padres opiniones diferentes. ¿Enfoque?",
                options: [
                    "Decidir rápido",
                    "Imponer opinión médica",
                    "Deliberación, reconocer incertidumbre, consenso valores",
                    "Esperar sin actuar"
                ],
                correct: 2,
                explanation: "Facilitar deliberación, reconocer incertidumbre, buscar consenso.",
                category: "casos_complejos"
            }, {
                id: "a_caso_2",
                question: "¿Cuándo indicada sedación paliativa terminal?",
                options: [
                    "Cuando familia solicite",
                    "Nunca",
                    "Síntomas graves refractarios fase final, tras deliberación",
                    "Solo >1 mes"
                ],
                correct: 2,
                explanation: "Último recurso para síntomas refractarios, requiere deliberación.",
                category: "casos_complejos"
            }, {
                id: "a_caso_3",
                question: "Cardiopatía compleja, cirugía alto riesgo, padres indecisos. ¿Hacer?",
                options: [
                    "Insistir cirugía",
                    "Rechazar automático",
                    "Explorar valores, tiempo, presentar opciones, apoyar decisión",
                    "Dejar decidir solos"
                ],
                correct: 2,
                explanation: "Explorar valores, dar tiempo, presentar opciones, apoyar decisión informada.",
                category: "casos_complejos"
            }, {
                id: "a_etic_1",
                question: "Padres solicitan RCP en anencefalia. ¿Enfoque?",
                options: [
                    "Acceder siempre",
                    "Negarse",
                    "Explorar valores, explicar futilidad, alternativas dignas, mediación",
                    "Realizar sin discutir"
                ],
                correct: 2,
                explanation: "Explorar valores, explicar futilidad, ofrecer alternativas, mediar si persiste.",
                category: "dilemas_eticos"
            }, {
                id: "a_etic_2",
                question: "Equipo considera fútil pero familia demanda. ¿Hacer?",
                options: [
                    "Siempre proporcionar",
                    "Negarse sin explicar",
                    "Diálogo, explorar miedos, second opinion, mediación",
                    "Ignorar"
                ],
                correct: 2,
                explanation: "Requiere diálogo profundo, explorar miedos, segunda opinión, mediación.",
                category: "dilemas_eticos"
            }, {
                id: "a_etic_3",
                question: "¿Éticamente aceptable retirar soporte vital?",
                options: [
                    "Nunca",
                    "Siempre",
                    "Sí, cuando beneficios no superan cargas tras deliberación",
                    "Solo judicial"
                ],
                correct: 2,
                explanation: "Aceptable cuando cargas superan beneficios tras deliberación con familia.",
                category: "dilemas_eticos"
            }, {
                id: "a_coord_1",
                question: "Alta domicilio CPP. ¿Elementos cruciales?",
                options: [
                    "Solo verbales",
                    "ACP documentado, coordinación comunitaria, 24/7, medicación",
                    "Solo padres",
                    "Esperar llamadas"
                ],
                correct: 1,
                explanation: "Requiere ACP, coordinación, acceso 24/7, medicación preparada.",
                category: "coordinacion"
            }, {
                id: "a_coord_2",
                question: "¿Qué incluir en kit emergencia domiciliario?",
                options: [
                    "Solo orales",
                    "Opioides, benzodiacepinas, antieméticos, contactos 24/7, plan",
                    "Nada, 112",
                    "Solo documentos"
                ],
                correct: 1,
                explanation: "Medicación emergencia, instrucciones, contactos 24/7, plan acción.",
                category: "coordinacion"
            }, {
                id: "a_coord_3",
                question: "¿Cómo coordinar transición prenatal-neonatal?",
                options: [
                    "No necesario",
                    "Solo historia",
                    "Reunión conjunta, plan parto, presencia equipo, revisión",
                    "Esperar parto"
                ],
                correct: 2,
                explanation: "Requiere reunión multidisciplinar, plan documentado, presencia en parto, revisión.",
                category: "coordinacion"
            }, {
                id: "a_espec_1",
                question: "Gemelar: T18 uno, otro sano. ¿Planificar?",
                options: [
                    "Tratar iguales",
                    "Ignorar afectado",
                    "Individualizado, preparar dualidad cuidar/sufrir pérdida",
                    "Terminación ambos"
                ],
                correct: 2,
                explanation: "Planes individualizados, preparación para complejidad emocional.",
                category: "escenarios_especificos"
            }, {
                id: "a_espec_2",
                question: "¿Cómo abordar donación órganos/tejidos?",
                options: [
                    "Nunca discutir",
                    "Obligar donar",
                    "Discusión temprana equipo donación, respetar deseos, facilitar",
                    "Sin consentimiento"
                ],
                correct: 2,
                explanation: "Contacto precoz equipo especializado, discutir con sensibilidad, respetar deseos.",
                category: "escenarios_especificos"
            }, {
                id: "a_espec_3",
                question: "¿Cómo manejar extubación compasiva?",
                options: [
                    "Rápido sin preparar",
                    "No extubar",
                    "Preparar familia, plan síntomas, presencia familiar, sostener bebé",
                    "Sin familia"
                ],
                correct: 2,
                explanation: "Preparación familiar, plan síntomas, presencia y participación familiar.",
                category: "escenarios_especificos"
            }, {
                id: "a_espec_4",
                question: "Diagnóstico postnatal difiere (menos grave). ¿Proceder?",
                options: [
                    "Continuar paliativo",
                    "Cambiar sin hablar",
                    "Reunión urgente, reevaluar, ajustar según nueva información y deseos",
                    "Culpar equipo"
                ],
                correct: 2,
                explanation: "Honestidad, reunión urgente, reevaluación, ofrecer nuevas opciones.",
                category: "escenarios_especificos"
            }, {
                id: "a_espec_5",
                question: "Familia diferente cultura solicita rituales. ¿Responder?",
                options: [
                    "Rechazar por normas",
                    "Ignorar",
                    "Facilitar rituales, adaptar procedimientos, mediación cultural",
                    "Imponer occidental"
                ],
                correct: 2,
                explanation: "Fundamental respetar y facilitar rituales culturales/religiosos.",
                category: "escenarios_especificos"
            }, {
                id: "a_espec_6",
                question: "¿Cuándo considerar traslado hospicio?",
                options: [
                    "Nunca",
                    "Solo si pagan",
                    "Si pronóstico días-semanas, familia desea, hospicio puede cuidar",
                    "Solo agonal"
                ],
                correct: 2,
                explanation: "Apropiado si pronóstico limitado, familia desea, hospicio puede manejar necesidades.",
                category: "escenarios_especificos"
            }]
        };

        // Updated Medals Data
        const medalsData = [{
            id: "comunicacion",
            name: "Comunicación Efectiva",
            icon: "🏅",
            description: "5 respuestas correctas categoría comunicación",
            requirement: 5,
            category: "comunicacion"
        }, {
            id: "empatia",
            name: "Empatía Clínica",
            icon: "💚",
            description: "Completar nivel principiante",
            requirement: "complete_beginner"
        }, {
            id: "sintomas",
            name: "Manejo Sintomático",
            icon: "🩺",
            description: "Completar 2 misiones clínicas con enfoque en síntomas",
            requirement: "mission_sintomas_2"
        }, {
            id: "familia",
            name: "Apoyo Familiar",
            icon: "👨‍👩‍👧",
            description: "5 respuestas correctas apoyo familiar",
            requirement: 5,
            category: "apoyo_familiar"
        }, {
            id: "etica",
            name: "Ética y Toma de Decisiones",
            icon: "⚖️",
            description: "5 respuestas correctas ética",
            requirement: 5,
            category: "etica"
        }, {
            id: "espiritual",
            name: "Apoyo Espiritual",
            icon: "🙏",
            description: "3 respuestas correctas en plano espiritual (misiones)",
            requirement: "mission_espiritual_3"
        }, {
            id: "psicologico",
            name: "Apoyo Psicológico",
            icon: "🧠",
            description: "3 respuestas correctas en plano psicológico (misiones)",
            requirement: "mission_psicologico_3"
        }, {
            id: "maestro",
            name: "Maestro CPP",
            icon: "🌟",
            description: "Completar los 3 niveles",
            requirement: "complete_all_levels"
        }];

        // Motivational Messages
        const motivationalMessages = [
            "Avanzas con sensibilidad y ciencia",
            "Cuidar también es aprender",
            "Excelente comprensión de los cuidados paliativos",
            "Tu conocimiento ayudará a muchas familias",
            "Cada respuesta es un paso hacia la excelencia",
            "Demuestras gran empatía y profesionalismo",
            "Tu compromiso marca la diferencia"
        ];
        // Preguntas de reserva para desbloqueo de medallas
        // Cada categoría corresponde a una medalla y contiene al menos 5 preguntas.
        const unlockPools = {
            comunicacion: [{
                id: "u_com_1",
                question: "¿Cuál es el principio fundamental al comunicar malas noticias?",
                options: [
                    "Ser rápido y conciso",
                    "Honestidad, sensibilidad y respeto, en privacidad",
                    "Usar terminología médica compleja",
                    "Evitar hablar de la muerte"
                ],
                correct: 1,
                explanation: "La comunicación de malas noticias debe ser honesta y sensible, respetando la privacidad y el ritmo de la familia.",
                category: "comunicacion"
            }, {
                id: "u_com_2",
                question: "ACOG sugiere preparar a las familias para posibles diferencias de opinión entre miembros de la familia y profesionales; ¿qué implica esto para la comunicación?",
                options: [
                    "Anticipar y abordar abiertamente los desacuerdos para mejorar la toma de decisiones",
                    "Ignorar opiniones disidentes",
                    "Dejar que la familia decida sin opinión médica",
                    "Evitar discutir puntos de vista diferentes"
                ],
                correct: 0,
                explanation: "El documento del ACOG señala que las familias deben prepararse para diferencias de opinión y que la comunicación abierta ayuda a consensuar las decisiones【75854725901059†L96-L110】.",
                category: "comunicacion"
            }, {
                id: "u_com_3",
                question: "Según la guía 'Together for Short Lives', ¿qué papel tiene la comunicación durante el apoyo psicológico desde el diagnóstico?",
                options: [
                    "Incluir a la familia extendida y hermanos, ofrecer soporte 24 h y abordar necesidades sociales",
                    "Esperar al nacimiento para hablar con la familia",
                    "Mantener información solo con los médicos",
                    "Limitar conversaciones para no provocar ansiedad"
                ],
                correct: 0,
                explanation: "La guía sugiere que el apoyo psicológico y social comience desde el diagnóstico, incluyendo a los hermanos y familia extendida, ofreciendo apoyo práctico y contacto 24 h【322938794583924†L870-L913】.",
                category: "comunicacion"
            }, {
                id: "u_com_4",
                question: "Al discutir opciones de reanimación y alimentación en el plan de parto, ¿qué aspecto comunicativo es clave?",
                options: [
                    "Escuchar las preferencias de la familia, explicar opciones y documentar decisiones compartidas",
                    "Imponer la opinión médica sin discusión",
                    "Evitar detalles para no asustar",
                    "Delegar la decisión a un miembro de la familia"
                ],
                correct: 0,
                explanation: "La planificación del parto incluye discutir reanimación, analgesia y alimentación; es esencial escuchar y documentar las decisiones compartidas【75854725901059†L96-L110】【631067499826330†L3250-L3356】.",
                category: "comunicacion"
            }, {
                id: "u_com_5",
                question: "Para abordar las necesidades espirituales de la familia, ¿qué se recomienda?",
                options: [
                    "Explorar sus creencias, considerar la participación de líderes religiosos y buscar compatibilidad con el plan de cuidados",
                    "Ignorar el aspecto espiritual",
                    "Convencerles de cambiar sus creencias",
                    "Referirlos exclusivamente a un consejero religioso"
                ],
                correct: 0,
                explanation: "Involucrar las creencias de la familia y, cuando sea apropiado, líderes religiosos, facilita un plan de cuidados compatible con sus valores.",
                category: "comunicacion"
            }],
            familia: [{
                id: "u_fam_1",
                question: "¿Por qué es importante incluir a hermanos y familia extendida en el apoyo desde el diagnóstico según la guía 'Together for Short Lives'?",
                options: [
                    "Porque abordar sus necesidades psicológicas y sociales, ofreciendo apoyo práctico y contacto 24 h, mejora la adaptabilidad familiar y el bienestar del recién nacido",
                    "Porque sus opiniones deben determinar el plan médico de forma exclusiva",
                    "Porque se espera que se responsabilicen de todos los cuidados del bebé",
                    "No es relevante; la atención se centra solo en los padres"
                ],
                correct: 0,
                explanation: "La guía destaca la importancia de apoyar a hermanos y familia extensa con recursos sociales y psicológicos desde el diagnóstico【322938794583924†L870-L913】.",
                category: "apoyo_familiar"
            }, {
                id: "u_fam_2",
                question: "La guía 'Together for Short Lives' indica que el apoyo social debe proporcionar...",
                options: [
                    "Ayuda práctica, apoyo emocional y contacto 24 h para la familia",
                    "Solo asistencia financiera",
                    "Nada, ya que la familia no debe depender del equipo",
                    "Apoyo psicológico solo para el bebé"
                ],
                correct: 0,
                explanation: "El documento recomienda apoyo práctico, emocional y contacto permanente para la familia, además de incluir a la familia extensa【322938794583924†L870-L913】.",
                category: "apoyo_familiar"
            }, {
                id: "u_fam_3",
                question: "Las recomendaciones del SEN señalan que la familia debe involucrarse en la deliberación sobre sedación paliativa; esto es importante porque...",
                options: [
                    "La decisión se basa en el mejor interés del bebé y debe ser compartida entre equipo y familia",
                    "La familia decide sola sin información",
                    "Los médicos deciden sin consultar",
                    "No es relevante porque la sedación es protocolo"
                ],
                correct: 0,
                explanation: "La sedación paliativa es un último recurso para síntomas refractarios y requiere deliberación conjunta; documentar el proceso evita culpabilizar a la familia【631067499826330†L1980-L2090】.",
                category: "apoyo_familiar"
            }, {
                id: "u_fam_4",
                question: "Según ACOG, el equipo de CPP debe preparar a la familia para posibles diferencias de opinión entre familiares y profesionales; esto incluye...",
                options: [
                    "Explorar valores de cada miembro y encontrar un consenso para el bienestar del neonato",
                    "Imponer la opinión profesional",
                    "Evitar debatir para no causar tensión",
                    "Dejar que solo la madre decida"
                ],
                correct: 0,
                explanation: "ACOG enfatiza la necesidad de anticipar y abordar diferencias de opinión mediante diálogo respetuoso para alcanzar decisiones centradas en el bienestar del bebé【75854725901059†L96-L110】.",
                category: "apoyo_familiar"
            }, {
                id: "u_fam_5",
                question: "Cuando el pronóstico es incierto, 'Together for Short Lives' sugiere hablar con la familia sobre...",
                options: [
                    "Varios planes de cuidado (supervivencia vs final de vida), sus preocupaciones y necesidades",
                    "Solo un plan de cuidados intensivos",
                    "No hablar hasta que nazca el bebé",
                    "Solo mencionar opciones curativas"
                ],
                correct: 0,
                explanation: "Al existir incertidumbre, se recomienda derivar tempranamente al equipo de CPP y desarrollar planes flexibles que contemplen distintos desenlaces【322938794583924†L965-L977】【631067499826330†L3250-L3356】.",
                category: "apoyo_familiar"
            }],
            etica: [{
                id: "u_eth_1",
                question: "Cuando surge un conflicto de valores sobre la limitación del esfuerzo terapéutico, las recomendaciones del SEN indican que...",
                options: [
                    "Se debe deliberar sobre los hechos y valores en conflicto, explorar alternativas y decidir en el mejor interés del recién nacido, manteniendo la comunicación con los padres",
                    "La decisión final recae únicamente en los médicos especialistas",
                    "La familia siempre tiene la última palabra sin considerar criterios clínicos",
                    "Se suspende la discusión hasta que intervenga un juez"
                ],
                correct: 0,
                explanation: "El SEN destaca la importancia de deliberar juntos sobre hechos y valores, buscando la mejor opción para el neonato【631067499826330†L1980-L2090】.",
                category: "etica"
            }, {
                id: "u_eth_2",
                question: "Según el SEN, la sedación paliativa en la fase final de la vida...",
                options: [
                    "Debe considerarse como último recurso para síntomas refractarios tras deliberación conjunta del equipo y los padres, documentando la decisión y sin exigir firma de consentimiento",
                    "Se aplica inmediatamente ante cualquier síntoma leve sin consulta a la familia",
                    "Requiere siempre la firma de los padres como consentimiento para evitar responsabilidades",
                    "Se utiliza principalmente para acelerar el fallecimiento del recién nacido"
                ],
                correct: 0,
                explanation: "La sedación paliativa es un recurso excepcional para síntomas refractarios; requiere consenso y documentación, evitando pedir firmas que aumenten la culpa【631067499826330†L1980-L2090】.",
                category: "etica"
            }, {
                id: "u_eth_3",
                question: "El documento de ACOG sugiere que la atención debe centrarse en maximizar la calidad de vida y el confort; éticamente esto implica...",
                options: [
                    "Evaluar beneficios y cargas de los tratamientos, priorizando confort y deseos familiares",
                    "Prolongar la vida sin considerar calidad",
                    "Tomar decisiones sólo por criterios económicos",
                    "Evitar el uso de analgésicos"
                ],
                correct: 0,
                explanation: "ACOG enfatiza que la atención se orienta a maximizar la calidad de vida y confort, lo que implica evaluar tratamientos y respetar deseos familiares【75854725901059†L16-L99】.",
                category: "etica"
            }, {
                id: "u_eth_4",
                question: "La guía de la BAPM (2024) enfatiza que los cuidados paliativos perinatales son responsabilidad de todos los equipos; éticamente esto implica...",
                options: [
                    "Que las decisiones se compartan entre todas las disciplinas y la familia, integrando los cuidados desde el diagnóstico",
                    "Delegar la responsabilidad a un equipo especializado y mantener a los padres al margen",
                    "Limitar la atención paliativa al final de vida",
                    "Evitar combinar tratamientos curativos y paliativos"
                ],
                correct: 0,
                explanation: "La BAPM destaca que el cuidado paliativo es responsabilidad de todos y debe integrarse desde el diagnóstico con manejo de síntomas y empoderamiento de los padres【796670985823923†L93-L117】.",
                category: "etica"
            }, {
                id: "u_eth_5",
                question: "Las recomendaciones del SEN indican que la deliberación sobre sedación y otras decisiones no requiere firma de consentimiento; ¿por qué?",
                options: [
                    "Porque pedir la firma puede aumentar la culpa de los padres y la decisión debe constar en la historia clínica como proceso compartido",
                    "Porque las firmas no tienen validez legal",
                    "Porque los médicos deciden solos",
                    "Porque no se documenta nada en CPP"
                ],
                correct: 0,
                explanation: "El SEN señala que exigir una firma puede incrementar el sentimiento de culpa; lo importante es documentar la deliberación conjunta en la historia clínica【631067499826330†L1980-L2090】.",
                category: "etica"
            }],
            // Preguntas de desbloqueo adicionales para las medallas basadas en misiones y niveles.
            // Cada pool incluye 5 preguntas de elección múltiple y una pregunta de caso clínico marcada con isCase:true.
            empatia: [{
                id: "u_empa_1",
                question: "¿Cuándo debería comenzar el apoyo psicológico en el contexto del CPP?",
                options: [
                    "Debe comenzar desde el diagnóstico e incluir a toda la familia, con apoyo social y asistencia continua",
                    "Solo tras el nacimiento",
                    "Solamente al final de vida",
                    "Exclusivamente para los padres"
                ],
                correct: 0,
                explanation: "La guía sugiere que el apoyo psicológico y social comience desde el diagnóstico, incluyendo hermanos y familia extensa, ofreciendo apoyo práctico y contacto 24 h【322938794583924†L870-L913】.",
                category: "empatia"
            }, {
                id: "u_empa_2",
                question: "La BAPM (2024) subraya que el CPP no es solo fin de vida; en términos de empatía clínica, esto implica...",
                options: [
                    "Integrar la atención al confort desde el diagnóstico, con participación de todos los equipos y padres",
                    "Esperar a la transición a cuidados intensivos",
                    "Separar tratamientos curativos y paliativos",
                    "Evitar reuniones para no angustiar"
                ],
                correct: 0,
                explanation: "La BAPM describe los cuidados paliativos como un enfoque activo que incluye manejo de síntomas, planificación en paralelo y empoderamiento de los padres desde el diagnóstico【796670985823923†L93-L117】.",
                category: "empatia"
            }, {
                id: "u_empa_3",
                question: "ACOG recomienda preparar a las familias para diferencias de opinión; ¿cómo esto refleja empatía clínica?",
                options: [
                    "Escuchar y considerar los valores de cada miembro para alcanzar decisiones compartidas",
                    "Evitar controversias ocultando opciones",
                    "Permitir que solo el médico decida",
                    "Reducir la participación de la familia"
                ],
                correct: 0,
                explanation: "El documento del ACOG señala que las familias deben prepararse para diferencias de opinión y que la comunicación abierta ayuda a consensuar las decisiones【75854725901059†L96-L110】.",
                category: "empatia"
            }, {
                id: "u_empa_4",
                question: "El SEN sugiere que los programas de CPP sean estructurados con formación básica para todos; ¿por qué esto es relevante para la empatía clínica?",
                options: [
                    "Permite un enfoque holístico y empático a través de formación básica para todos los profesionales",
                    "Solo un equipo especializado decide sin considerar la familia",
                    "Reduce la carga emocional del personal",
                    "Elimina la necesidad de apoyo psicológico"
                ],
                correct: 0,
                explanation: "Las recomendaciones del SEN describen un enfoque coordinado para anticipar, prevenir y tratar el sufrimiento físico, psicológico, social y espiritual desde el diagnóstico hasta el duelo, enfatizando la formación de todos los profesionales【631067499826330†L3250-L3420】.",
                category: "empatia"
            }, {
                id: "u_empa_5",
                question: "¿Por qué, según el SEN, no debe solicitarse la firma de los padres al deliberar la sedación paliativa?",
                options: [
                    "Evitar solicitar firma para no aumentar la culpa, documentando la deliberación compartida",
                    "Eximir al equipo de responsabilidad",
                    "La familia decide sola sin información",
                    "Implementar sedación de manera automática"
                ],
                correct: 0,
                explanation: "El SEN explica que la sedación paliativa es un último recurso para síntomas refractarios y que pedir una firma podría incrementar la culpabilidad; se recomienda documentar la deliberación compartida en la historia clínica【631067499826330†L1980-L2090】.",
                category: "empatia"
            }, {
                id: "u_empa_case",
                isCase: true,
                question: "Caso clínico: Sofía y Luis reciben el diagnóstico de trisomía 13 a las 22 semanas. Desean continuar el embarazo y están angustiados. ¿Cuál de las siguientes intervenciones iniciales refleja mejor la empatía clínica según las guías?",
                options: [
                    "Ofrecer apoyo psicológico y social inmediato a la familia, explicar planes paralelos y escuchar sus valores y prioridades",
                    "Remitirlos al equipo de neonatología al final del embarazo y evitar conversaciones detalladas hasta el nacimiento",
                    "Aconsejar la interrupción del embarazo sin discusión y remitir a un especialista legal",
                    "Proporcionar únicamente información médica técnica y posponer el apoyo emocional"
                ],
                correct: 0,
                explanation: "Las guías recomiendan iniciar el apoyo psicológico y social desde el diagnóstico, incluir a la familia, discutir planes paralelos y escuchar sus valores para reducir la incertidumbre【322938794583924†L825-L842】【322938794583924†L870-L913】.",
                category: "empatia"
            }],
            sintomas: [{
                id: "u_sint_1",
                question: "¿Cómo define el SEN la sedación paliativa en la fase final de la vida?",
                options: [
                    "Se utiliza como último recurso para síntomas refractarios, tras deliberación conjunta y documentando el proceso",
                    "Se aplica inmediatamente tras el diagnóstico para aliviar cualquier molestia",
                    "Sirve para acelerar el fallecimiento del neonato",
                    "Se administra sin necesidad de discutirlo con la familia"
                ],
                correct: 0,
                explanation: "El SEN indica que la sedación paliativa es un último recurso para síntomas refractarios y requiere deliberación conjunta con los padres, documentando la decisión y evitando pedir firmas【631067499826330†L1980-L2090】.",
                category: "sintomas"
            }, {
                id: "u_sint_2",
                question: "En la planificación del parto, según el SEN, el manejo sintomático debe incluir...",
                options: [
                    "Resucitación, analgesia y sedación, tratamiento de síntomas (dolor, disnea, agitación) y alimentación, con flexibilidad para supervivencia mayor a una hora",
                    "Solo analgesia posnatal",
                    "Evitar cualquier intervención para permitir que la naturaleza siga su curso",
                    "Obligación de ventilación mecánica en todos los casos"
                ],
                correct: 0,
                explanation: "El plan de parto debe contemplar reanimación, analgesia, sedación, tratamiento de síntomas, alimentación y planes paralelos para supervivencia más allá de una hora【631067499826330†L3250-L3356】.",
                category: "sintomas"
            }, {
                id: "u_sint_3",
                question: "La guía BAPM (2024) subraya que el CPP incluye...",
                options: [
                    "Manejo de síntomas, planificación en paralelo y empoderamiento de los padres, integrado desde el diagnóstico",
                    "Solo soportes psicológicos",
                    "Finalización del tratamiento al nacer",
                    "Aislamiento de la familia de las decisiones"
                ],
                correct: 0,
                explanation: "La BAPM señala que los cuidados paliativos perinatales son un enfoque activo con manejo de síntomas, planificación en paralelo y empoderamiento parental como parte de la atención diaria【796670985823923†L93-L117】.",
                category: "sintomas"
            }, {
                id: "u_sint_4",
                question: "ACOG afirma que el objetivo del CPP es maximizar la calidad de vida y confort; ¿cómo se relaciona esto con el manejo de síntomas?",
                options: [
                    "Incluye analgesia, alivio de disnea, control de síntomas y soporte afectivo continuando con tratamientos dirigidos a prolongar la vida",
                    "Exige suspender todos los tratamientos curativos",
                    "Prioriza la duración de la vida sobre el confort",
                    "Se limita a medidas psicológicas para la familia"
                ],
                correct: 0,
                explanation: "ACOG describe el CPP como una estrategia coordinada que se centra en la calidad de vida y el confort, proporcionando analgesia y otros cuidados junto con tratamientos prolongadores de vida【75854725901059†L16-L99】.",
                category: "sintomas"
            }, {
                id: "u_sint_5",
                question: "Si el pronóstico es incierto, 'Together for Short Lives' recomienda...",
                options: [
                    "Derivar tempranamente al equipo de CPP para desarrollar planes paralelos y preparar estrategias flexibles de manejo sintomático para distintos desenlaces",
                    "Aplazar la discusión hasta el parto",
                    "Centrar la atención únicamente en reanimación intensiva",
                    "No implicar al equipo de CPP para no crear expectativas"
                ],
                correct: 0,
                explanation: "Cuando el pronóstico es incierto, se debe derivar pronto al equipo de CPP para crear planes de cuidado flexibles y paralelos, incluyendo estrategias de manejo de síntomas【322938794583924†L965-L977】.",
                category: "sintomas"
            }, {
                id: "u_sint_case",
                isCase: true,
                question: "Caso clínico: Pedro recibe el diagnóstico prenatal de trisomía 18 a las 30 semanas y decide priorizar el confort del recién nacido. ¿Qué plan garantiza un adecuado manejo sintomático según las guías?",
                options: [
                    "Discutir con la familia las opciones de analgesia, sedación y alimentación, planificar intervención mínima, preparar apoyo para supervivencia >1 h y documentar decisiones compartidas",
                    "Programar cesárea electiva y ventilación mecánica obligatoria",
                    "Abstenerse de discutir analgesia para evitar preocupaciones",
                    "Delegar el control de síntomas únicamente al neonatólogo"
                ],
                correct: 0,
                explanation: "El plan de parto debe contemplar analgesia, sedación y alimentación, acordar medidas de reanimación mínima y prever la posibilidad de supervivencia prolongada, registrando las decisiones compartidas【631067499826330†L3250-L3356】.",
                category: "sintomas"
            }],
            espiritual: [{
                id: "u_esp_1",
                question: "Según el SEN, ¿qué aspectos espirituales se deberían considerar en el plan de parto de un neonato con pronóstico fatal?",
                options: [
                    "Permitir rituales como bautismos inmediatos y respetar creencias de la familia, coordinando con profesionales",
                    "Restringir rituales religiosos por motivos sanitarios",
                    "Imponer una religión a la familia",
                    "Evitar cualquier celebración"
                ],
                correct: 0,
                explanation: "Las recomendaciones del SEN incluyen la planificación de rituales como bautismos, así como orientar a la familia en la despedida y rituales durante el parto【631067499826330†L3250-L3356】.",
                category: "espiritual"
            }, {
                id: "u_esp_2",
                question: "Involucrar líderes religiosos u otros referentes espirituales en la toma de decisiones se considera...",
                options: [
                    "Una práctica recomendada para alinear el plan de cuidados con las creencias de la familia y su bienestar emocional",
                    "Inaceptable en el ámbito sanitario",
                    "Obligatorio en todos los casos sin consultar a la familia",
                    "Irrelevante para los cuidados paliativos"
                ],
                correct: 0,
                explanation: "La planificación del parto puede incluir la participación de referentes espirituales de la familia para asegurar que los cuidados se alineen con sus valores y creencias, proporcionándoles consuelo【631067499826330†L3250-L3356】.",
                category: "espiritual"
            }, {
                id: "u_esp_3",
                question: "ACOG menciona que el CPP incluye apoyo prenatal, durante el parto y posparto con asesoría en duelo; esto es crucial en el plano espiritual porque...",
                options: [
                    "Acompaña a la familia en su proceso de duelo y respeta sus valores y creencias a lo largo del continuo de cuidados",
                    "Evita que la familia sienta dolor físico",
                    "Se centra exclusivamente en la intervención médica",
                    "Sustituye a los líderes religiosos de la familia"
                ],
                correct: 0,
                explanation: "ACOG describe el CPP como una estrategia coordinada que incluye apoyo en el duelo, lo que ayuda a acompañar a la familia respetando sus valores y creencias【75854725901059†L16-L99】.",
                category: "espiritual"
            }, {
                id: "u_esp_4",
                question: "El SEN recomienda incluir rituales familiares y orientación para la despedida durante el parto; esto...",
                options: [
                    "Proporciona consuelo espiritual y psicológico, y ayuda a preparar a la familia para el duelo",
                    "No tiene relevancia en el entorno sanitario",
                    "Debe evitarse por motivos de eficiencia",
                    "Se limita a familias con creencias religiosas"
                ],
                correct: 0,
                explanation: "Planificar rituales y orientar a la familia en la despedida brinda apoyo espiritual y psicológico y facilita el proceso de duelo【631067499826330†L3250-L3356】.",
                category: "espiritual"
            }, {
                id: "u_esp_5",
                question: "¿Qué implica el concepto de 'planeamiento en paralelo' en términos de apoyo espiritual?",
                options: [
                    "Preparar varios planes que incluyan aspectos médicos, psicológicos y espirituales para diferentes desenlaces, reduciendo incertidumbre y apoyando a la familia",
                    "Elaborar un único plan agresivo y dejar el resto a la improvisación",
                    "Evitar tratar los valores espirituales de la familia para no interferir",
                    "Dejar la preparación a último momento sin informar a la familia"
                ],
                correct: 0,
                explanation: "El planeamiento en paralelo implica desarrollar varios planes de cuidado para posibles desenlaces, incluyendo el acompañamiento espiritual, lo que ayuda a gestionar la incertidumbre y apoyar a la familia【322938794583924†L825-L842】.",
                category: "espiritual"
            }, {
                id: "u_esp_case",
                isCase: true,
                question: "Caso clínico: Natalia y su pareja anticipan un nacimiento con pronóstico fatal y desean realizar un bautismo inmediatamente después del parto. ¿Cómo debería el equipo de CPP abordar este deseo?",
                options: [
                    "Incluir en el plan de cuidados la posibilidad de bautismo u otro ritual, coordinar con la familia y el hospital para respetar sus creencias y brindar apoyo emocional",
                    "Negarse a cualquier ritual religioso para mantener la neutralidad",
                    "Imponer un ritual diferente que se considere más apropiado",
                    "Postergar el ritual hasta que el equipo lo considere"
                ],
                correct: 0,
                explanation: "Las recomendaciones del SEN sugieren planificar y coordinar rituales deseados por la familia, como el bautismo, para respetar sus creencias y brindar apoyo durante la despedida【631067499826330†L3250-L3356】.",
                category: "espiritual"
            }],
            psicologico: [{
                id: "u_psico_1",
                question: "¿Cuándo recomienda la guía 'Together for Short Lives' iniciar el apoyo psicológico?",
                options: [
                    "Desde el diagnóstico, involucrando a la familia y hermanos y proporcionando apoyo social y psicológico con seguimiento 24 h",
                    "Una vez nacido el bebé",
                    "Solo en la última fase de vida",
                    "Exclusivamente para los padres"
                ],
                correct: 0,
                explanation: "La guía sugiere que el apoyo psicológico y social debe comenzar desde el diagnóstico, incluyendo a hermanos y familia extensa, con apoyo práctico y contacto permanente【322938794583924†L870-L913】.",
                category: "psicologico"
            }, {
                id: "u_psico_2",
                question: "ACOG describe el CPP como un proceso que incluye consulta prenatal, plan de parto y apoyo durante el nacimiento y posparto; en términos psicológicos, esto implica...",
                options: [
                    "Acompañar a la familia a lo largo del proceso, proporcionar asesoría en duelo y acceso a especialidades y apoyo emocional",
                    "Limitar el apoyo a la fase prenatal",
                    "Evitar mencionar el duelo para no preocupar a la familia",
                    "Referir a la familia a psiquiatría sin seguimiento"
                ],
                correct: 0,
                explanation: "ACOG destaca que el CPP es una estrategia coordinada que incluye consulta prenatal, plan de parto y apoyo durante el embarazo, parto y posparto, así como asesoría en duelo【75854725901059†L16-L99】.",
                category: "psicologico"
            }, {
                id: "u_psico_3",
                question: "El SEN sugiere que los programas de CPP se estructuren en hospitales de nivel terciario con formación básica para todos; ¿por qué esto es importante para el apoyo psicológico?",
                options: [
                    "Porque permite desarrollar habilidades de comunicación y empatía en todo el equipo para atender las necesidades psicológicas de las familias",
                    "Porque evita la necesidad de psicólogos",
                    "Porque alivia la presión económica del hospital",
                    "Porque excluye a la familia del cuidado"
                ],
                correct: 0,
                explanation: "El SEN destaca la importancia de programas estructurados y formación básica para todos los profesionales con el fin de anticipar, prevenir y tratar el sufrimiento físico, psicológico, social y espiritual desde el diagnóstico hasta el duelo, enfatizando la formación de todos los profesionales【631067499826330†L3250-L3420】.",
                category: "psicologico"
            }, {
                id: "u_psico_4",
                question: "Según BAPM (2024), los cuidados paliativos perinatales deben empoderar a los padres y formar parte del cuidado cotidiano; ¿qué implica esto para el apoyo psicológico?",
                options: [
                    "Que todos los profesionales deben reconocer y atender las necesidades emocionales de la familia desde el diagnóstico, fomentando su participación en decisiones y su sensación de control",
                    "Que los padres deben ceder el control al equipo",
                    "Que solo un especialista en psicología se comunica con la familia",
                    "Que no se debe mencionar la situación para evitar angustia"
                ],
                correct: 0,
                explanation: "La BAPM destaca que el CPP es responsabilidad de todos los equipos y debe integrarse desde el diagnóstico, con manejo de síntomas y empoderamiento de los padres【796670985823923†L93-L117】.",
                category: "psicologico"
            }, {
                id: "u_psico_5",
                question: "Las recomendaciones del SEN señalan que las deliberaciones sobre decisiones difíciles deben basarse en hechos y valores en conflicto; esto es relevante psicológicamente porque...",
                options: [
                    "Reduce la ansiedad y la culpa al involucrar a la familia en la toma de decisiones compartidas y en la comprensión de las opciones",
                    "Permite a los médicos decidir solos para simplificar el proceso",
                    "Implica que la familia no necesita conocer las opciones",
                    "Evita conflictos al excluir a la familia de la conversación"
                ],
                correct: 0,
                explanation: "Las recomendaciones del SEN explican que se debe deliberar sobre hechos y valores en conflicto con los padres para decidir en el mejor interés del bebé; esto favorece la comprensión y reduce sentimientos de culpa【631067499826330†L1980-L2090】.",
                category: "psicologico"
            }, {
                id: "u_psico_case",
                isCase: true,
                question: "Caso clínico: Alicia y Miguel se sienten abrumados por la decisión sobre límites terapéuticos para su neonato. ¿Cuál intervención del equipo refleja un buen apoyo psicológico?",
                options: [
                    "Facilitar reuniones de deliberación compartida para analizar hechos, valores y opciones, brindar información y apoyo emocional, y respetar el ritmo de la familia",
                    "Imponer la decisión del equipo médico sin escuchar a los padres",
                    "Evitar hablar del tema para no aumentar su ansiedad",
                    "Remitirlos a un trabajador social sin involucrar al equipo tratante"
                ],
                correct: 0,
                explanation: "El SEN recomienda deliberar conjuntamente sobre hechos y valores y documentar la decisión, ofreciendo apoyo emocional durante el proceso para reducir la ansiedad y la culpa【631067499826330†L1980-L2090】.",
                category: "psicologico"
            }],
            maestro: [{
                id: "u_mae_1",
                question: "El concepto de plan en paralelo implica desarrollar múltiples planes para diferentes desenlaces; ¿cómo contribuye esto a la toma de decisiones?",
                options: [
                    "Permite reducir la incertidumbre y preparar a la familia para diversas posibilidades, fomentando decisiones compartidas",
                    "Obliga a la familia a seguir un único plan sin cambios",
                    "Elimina la necesidad de comunicación con la familia",
                    "Prolonga innecesariamente la vida sin considerar el confort"
                ],
                correct: 0,
                explanation: "El planeamiento en paralelo consiste en crear planes de cuidado flexibles para distintos desenlaces, lo que ayuda a gestionar la incertidumbre y favorece la participación de la familia【322938794583924†L825-L842】.",
                category: "maestro"
            }, {
                id: "u_mae_2",
                question: "ACOG describe el CPP como una estrategia para maximizar la calidad de vida y confort; ¿qué implica esto?",
                options: [
                    "Integrar analgesia, sedación, alimentación y apoyo emocional con tratamientos curativos, evaluando constantemente beneficios y cargas",
                    "Suspender todos los tratamientos que no sean curativos",
                    "Iniciar ventilación mecánica forzada en todos los casos",
                    "Dejar todas las decisiones en manos de un comité externo"
                ],
                correct: 0,
                explanation: "ACOG señala que el CPP puede darse junto a tratamientos prolongadores de vida, evaluando beneficios y cargas y priorizando el confort y la calidad de vida【75854725901059†L16-L99】.",
                category: "maestro"
            }, {
                id: "u_mae_3",
                question: "Las recomendaciones del SEN sobre sedación paliativa indican que no se debe solicitar la firma de consentimiento a los padres; ¿cuál es la razón?",
                options: [
                    "Se evita aumentar la culpa de los padres; lo importante es documentar la deliberación compartida en la historia clínica",
                    "Para eximir al equipo de cualquier responsabilidad legal",
                    "Porque la sedación es obligatoria y no requiere aprobación",
                    "Porque la ley no requiere ningún documento"
                ],
                correct: 0,
                explanation: "El SEN explica que exigir una firma puede incrementar la culpa de los padres; la sedación debe acordarse conjuntamente y documentarse en la historia clínica【631067499826330†L1980-L2090】.",
                category: "maestro"
            }, {
                id: "u_mae_4",
                question: "Según BAPM, los cuidados paliativos perinatales son responsabilidad de todos los equipos; ¿por qué es importante para el enfoque integral?",
                options: [
                    "Porque garantiza que el manejo de síntomas, planificación en paralelo y apoyo emocional se integren en la atención diaria con participación de los padres",
                    "Porque exime al equipo de neonatología de participar en la atención",
                    "Porque delega la responsabilidad al cuidado exclusivo de los padres",
                    "Porque solo se aplica en la fase terminal"
                ],
                correct: 0,
                explanation: "La BAPM destaca que los cuidados paliativos perinatales son responsabilidad de todos los equipos y deben integrarse desde el diagnóstico, incluyendo el manejo de síntomas, planes paralelos y empoderamiento parental【796670985823923†L93-L117】.",
                category: "maestro"
            }, {
                id: "u_mae_5",
                question: "Las recomendaciones del SEN indican que los programas de CPP deben desarrollarse en hospitales de nivel terciario con formación para todos los profesionales; ¿qué ventajas ofrece para ser Maestro CPP?",
                options: [
                    "Favorece la coordinación interdisciplinaria y la continuidad de cuidados, mejorando el resultado para la familia y el bebé",
                    "Permite delegar al personal menos calificado las decisiones difíciles",
                    "Reduce la necesidad de comunicación con la familia",
                    "Limita el apoyo al equipo de neonatología"
                ],
                correct: 0,
                explanation: "Los programas estructurados en hospitales terciarios con formación para todos los profesionales aseguran un enfoque coordinado y continuo, mejorando el resultado para la familia y el bebé【631067499826330†L3250-L3420】.",
                category: "maestro"
            }, {
                id: "u_mae_case",
                isCase: true,
                question: "Caso clínico: Un neonato con diagnóstico de síndrome de Edwards nace y sus padres desean cuidados de confort. Tienen dudas sobre reanimación y plan de parto. ¿Cuál estrategia de Maestro CPP se ajusta a las guías?",
                options: [
                    "Desarrollar planes paralelos, discutir reanimación, analgesia, sedación y alimentación con la familia, documentar las decisiones y ofrecer apoyo psicológico y espiritual continuo",
                    "Proponer una cesárea y ventilación mecánica obligatoria, limitando la comunicación con los padres",
                    "Dejar todas las decisiones a la familia sin guía profesional",
                    "Imponer el plan del equipo sin considerar los valores de la familia"
                ],
                correct: 0,
                explanation: "Las guías recomiendan elaborar planes paralelos, discutir reanimación, analgesia, sedación y alimentación, documentar las decisiones compartidas y brindar apoyo psicológico y espiritual para satisfacer las necesidades de la familia【322938794583924†L825-L842】【631067499826330†L3250-L3356】.",
                category: "maestro"
            }]
        };

        // Complete Clinical Mission Data (15 missions - 5 per level)
        const clinicalMissions = {
            beginner: [{
                id: "mission_b_1",
                title: "Diagnóstico prenatal de anencefalia",
                description: "María, 28 años, 24 semanas, anencefalia confirmada. Deciden continuar embarazo.",
                scenario: "María y Juan acuden tras diagnóstico. Devastados pero desean continuar y conocer a su bebé.",
                questions: [{
                    aspect: "sintomas",
                    icon: "💊",
                    question: "En plan de parto, ¿monitorización fetal durante trabajo?",
                    options: [
                        "Continua obligatoria",
                        "Puede diferirse según deseos informados",
                        "Cesárea electiva",
                        "Ningún control"
                    ],
                    correct: 1,
                    feedback: "Monitorización puede diferirse si padres informados, no modifica pronóstico."
                }, {
                    aspect: "espiritual",
                    icon: "🙏",
                    question: "Familia desea bautizar inmediatamente. ¿Respuesta?",
                    options: [
                        "Rechazar",
                        "No hay tiempo",
                        "Facilitar capellán o familia realice, incluir en plan",
                        "Ignorar"
                    ],
                    correct: 2,
                    feedback: "Facilitar rituales espirituales es esencial, coordinando capellanía."
                }, {
                    aspect: "psicologico",
                    icon: "🧠",
                    question: "María expresa culpa por continuar. ¿Responder?",
                    options: [
                        "No debe sentir culpa",
                        "Ignorar",
                        "Validar emociones, apoyo psicológico, normalizar duelo anticipatorio",
                        "Sugerir terminación"
                    ],
                    correct: 2,
                    feedback: "Validar emociones, ofrecer apoyo psicológico, normalizar duelo anticipatorio."
                }, {
                    aspect: "social",
                    icon: "👥",
                    question: "¿Cómo explicar a hija de 5 años?",
                    options: [
                        "No decir nada",
                        "Palabras complejas",
                        "Información apropiada edad, psicología infantil, participación",
                        "Mantener alejada"
                    ],
                    correct: 2,
                    feedback: "Información apropiada a edad, apoyo psicología infantil, permitir participación."
                }]
            }, {
                id: "mission_b_2",
                title: "Trisomía 18 diagnosticada 20 semanas",
                description: "Laura, 32 años, T18 confirmada amniocentesis. Deciden continuar.",
                scenario: "Solicitan información sobre qué esperar y cómo prepararse.",
                questions: [{
                    aspect: "sintomas",
                    icon: "💊",
                    question: "Tras nacer, dificultad respiratoria leve. ¿Enfoque paliativo?",
                    options: [
                        "Intubación inmediata",
                        "Posición, oxígeno suplementario, evitar invasivos",
                        "Nada",
                        "UCI urgente"
                    ],
                    correct: 1,
                    feedback: "Manejo confort: posicionamiento, oxígeno si mejora confort, evitar invasivos."
                }, {
                    aspect: "espiritual",
                    icon: "🙏",
                    question: "Abuelos diferentes creencias solicitan rituales. ¿Proceder?",
                    options: [
                        "Solo padres",
                        "Solo abuelos",
                        "Diálogo familiar, autonomía padres, honrar familia extendida",
                        "Prohibir abuelos"
                    ],
                    correct: 2,
                    feedback: "Facilitar diálogo, respetar autonomía padres, honrar familia extendida cuando posible."
                }, {
                    aspect: "psicologico",
                    icon: "🧠",
                    question: "Laura se siente juzgada. ¿Apoyo ofrecer?",
                    options: [
                        "Ignorar demás",
                        "Culpar",
                        "Validar, grupos apoyo, counseling, recursos educativos",
                        "Cambiar opinión"
                    ],
                    correct: 2,
                    feedback: "Validar experiencia, grupos apoyo, counseling psicológico."
                }, {
                    aspect: "social",
                    icon: "👥",
                    question: "Necesita baja laboral extendida. ¿Apoyo social?",
                    options: [
                        "Nada que hacer",
                        "Trabajo social: derechos laborales, tramitación, apoyo económico",
                        "Solo papel",
                        "Arreglarse sola"
                    ],
                    correct: 1,
                    feedback: "Trabajo social ayuda con derechos laborales, tramitación, apoyo económico."
                }]
            }, {
                id: "mission_b_3",
                title: "Agenesia renal bilateral 22 semanas",
                description: "Carmen, 26 años, Potter confirmado. Desean plan de cuidados.",
                scenario: "Diagnóstico letal confirmado. Pareja desea continuar y preparar plan.",
                questions: [{
                    aspect: "sintomas",
                    icon: "💊",
                    question: "Disnea severa por hipoplasia pulmonar. ¿Medidas confort?",
                    options: [
                        "VM inmediata",
                        "Piel con piel, posición, oxígeno, considerar morfina",
                        "No tocar",
                        "Reanimación completa"
                    ],
                    correct: 1,
                    feedback: "Prioridad confort: piel con piel, posición, oxígeno, opioides si disnea severa."
                }, {
                    aspect: "espiritual",
                    icon: "🙏",
                    question: "Ceremonia no religiosa junto a cama. ¿Responder?",
                    options: [
                        "Solo religiosas oficiales",
                        "Rechazar no religiosas",
                        "Facilitar espacio privado, respetar ceremonia, presencia deseada",
                        "Interrumpir"
                    ],
                    correct: 2,
                    feedback: "Apoyo espiritual incluye rituales no religiosos, facilitar privacidad."
                }, {
                    aspect: "psicologico",
                    icon: "🧠",
                    question: "¿Es normal sentir amor pese a saber que morirá?",
                    options: [
                        "No encariñarse",
                        "Evitar pregunta",
                        "Validar completamente, amor natural y esperado, fomentar vínculo",
                        "Cambiar tema"
                    ],
                    correct: 2,
                    feedback: "Validar completamente sentimientos de amor, es natural y debe fomentarse."
                }, {
                    aspect: "social",
                    icon: "👥",
                    question: "Vive lejos, dificultades económicas desplazamiento. ¿Apoyo?",
                    options: [
                        "No podemos ayudar",
                        "Trabajo social: alojamiento cercano, transporte, fondos emergencia",
                        "Ignorar",
                        "Solo teléfono taxi"
                    ],
                    correct: 1,
                    feedback: "Trabajo social explora alojamiento, ayudas transporte, fondos emergencia."
                }]
            }, {
                id: "mission_b_4",
                title: "Muerte fetal intraútero 38 semanas",
                description: "Sofía, 30 años, muerte fetal confirmada.",
                scenario: "Planifica inducción. Devastados, necesitan apoyo para parto y despedida.",
                questions: [{
                    aspect: "sintomas",
                    icon: "💊",
                    question: "Ansiedad severa y dolor durante trabajo. ¿Manejo?",
                    options: [
                        "Solo anestesia",
                        "Epidural si desea, apoyo emocional continuo, acompañante, tranquilo",
                        "Calmarse",
                        "Sedación completa"
                    ],
                    correct: 1,
                    feedback: "Manejo integral: analgesia, apoyo emocional constante, ambiente tranquilo."
                }, {
                    aspect: "espiritual",
                    icon: "🙏",
                    question: "¿Puede bautizar pese a nacer muerto?",
                    options: [
                        "No tiene sentido",
                        "Rechazar",
                        "Validar deseo, facilitar capellán o familia realice ritual",
                        "Burlarse"
                    ],
                    correct: 2,
                    feedback: "Validar deseo espiritual, facilitar capellanía o ritual familiar."
                }, {
                    aspect: "psicologico",
                    icon: "🧠",
                    question: "No quiere ver ni sostener tras nacimiento. ¿Responder?",
                    options: [
                        "Forzarla",
                        "Respetar decisión, ofrecer opción más tarde, no juzgar, apoyo",
                        "Juzgar",
                        "Insistir"
                    ],
                    correct: 1,
                    feedback: "Respetar completamente, ofrecer más tarde, no juzgar, continuar apoyo."
                }, {
                    aspect: "social",
                    icon: "👥",
                    question: "Hijo 3 años en casa. ¿Orientación involucrarle?",
                    options: [
                        "Ocultarle",
                        "Explicación apropiada edad, psicología, despedida, duelo infantil",
                        "Solo decir que se fue",
                        "No hablar"
                    ],
                    correct: 1,
                    feedback: "Información apropiada edad con psicología, opción despedida, duelo infantil."
                }]
            }, {
                id: "mission_b_5",
                title: "Hernia diafragmática congénita severa",
                description: "Patricia, 34 años, 32 semanas, HDC severa mal pronóstico.",
                scenario: "Pronóstico reservado incluso con cirugía. Familia solicita plan paliativo.",
                questions: [{
                    aspect: "sintomas",
                    icon: "💊",
                    question: "Plan de parto: ¿manejo disnea al nacer?",
                    options: [
                        "Intubación automática",
                        "Plan escalonado: evaluar, posición, oxígeno, valorar morfina, permitir sostener",
                        "Nada",
                        "Solo CPAP"
                    ],
                    correct: 1,
                    feedback: "Plan escalonado: evaluar severidad, confort, morfina si severa, contacto familiar."
                }, {
                    aspect: "espiritual",
                    icon: "🙏",
                    question: "Abuelos insisten rituales que padres no comparten. ¿Manejar?",
                    options: [
                        "Prohibir abuelos",
                        "Imponer abuelos",
                        "Mediación, autonomía padres, compromiso honrar todos",
                        "Excluir abuelos"
                    ],
                    correct: 2,
                    feedback: "Mediación sensible, respetar autonomía padres, intentar honrar todos."
                }, {
                    aspect: "psicologico",
                    icon: "🧠",
                    question: "Presión familiar para cirugía pese a mal pronóstico. ¿Apoyo?",
                    options: [
                        "Hacer caso familia",
                        "Criticar familia",
                        "Apoyo psicológico clarificar valores, mediación, validar autonomía",
                        "Aislarla"
                    ],
                    correct: 2,
                    feedback: "Apoyo para explorar valores propios, mediación si ayuda, validar autonomía."
                }, {
                    aspect: "social",
                    icon: "👥",
                    question: "Desea máximo tiempo casa tras nacer. ¿Coordinación?",
                    options: [
                        "Imposible",
                        "Sola a casa",
                        "Coordinación paliativos comunitarios, equipamiento, 24/7, medicación",
                        "No planificar"
                    ],
                    correct: 2,
                    feedback: "Coordinación con paliativos comunitarios, equipamiento, acceso 24/7, medicación preparada."
                }]
            }],
            intermediate: [{
                id: "mission_i_1",
                title: "Prematuridad extrema 22+6 semanas",
                description: "Recién nacido 22+6 sem, 450g, múltiples complicaciones.",
                scenario: "Tras semanas en UCI, desarrollo displasia broncopulmonar severa, hemorragia intraventricular grado IV.",
                questions: [{
                    aspect: "sintomas",
                    icon: "💊",
                    question: "Disnea refractaria a VM máxima. ¿Siguiente paso?",
                    options: [
                        "Aumentar parámetros ventilatorios",
                        "Considerar morfina paliativa tras conversación familiar",
                        "ECMO urgente",
                        "Esperar sin medicación"
                    ],
                    correct: 1,
                    feedback: "Conversación sobre confort, considerar morfina paliativa si objetivos cambian."
                }, {
                    aspect: "espiritual",
                    icon: "🙏",
                    question: "Familia musulmana solicita rituales específicos. ¿Facilitar?",
                    options: [
                        "Solo rituales cristianos",
                        "Facilitar imam, orientación Meca, rituales familiares, privacidad",
                        "No hay tiempo para rituales",
                        "Imponer rutinas hospital"
                    ],
                    correct: 1,
                    feedback: "Respetar creencias religiosas, facilitar imam, orientación, privacidad."
                }, {
                    aspect: "psicologico",
                    icon: "🧠",
                    question: "Madre culpa personal por parto prematuro. ¿Abordar?",
                    options: [
                        "No es culpa suya, no pensar",
                        "Explorar sentimientos, psicología especializada, grupos apoyo",
                        "Ignorar culpabilidad",
                        "Focalizarse solo en tratamiento"
                    ],
                    correct: 1,
                    feedback: "Explorar sentimientos culpa, derivar psicología, grupos apoyo específicos."
                }, {
                    aspect: "social",
                    icon: "👥",
                    question: "Padre trabaja lejos, no puede estar presente. ¿Apoyo?",
                    options: [
                        "No es prioritario",
                        "Trabajo social: licencias, videoconferencias, flexible visitas",
                        "Solo fines de semana",
                        "Madre suficiente"
                    ],
                    correct: 1,
                    feedback: "Trabajo social para licencias, facilitar tecnología, flexibilizar horarios."
                }]
            }, {
                id: "mission_i_2",
                title: "Trisomía 13 con dilema quirúrgico",
                description: "Neonata T13, cardiopatía compleja operable pero alto riesgo.",
                scenario: "Equipo cardíaco ofrece cirugía 30% supervivencia, pero familia indecisa.",
                questions: [{
                    aspect: "sintomas",
                    icon: "💊",
                    question: "Cianosis severa, irritabilidad. ¿Manejo si rechazan cirugía?",
                    options: [
                        "Oxígeno, morfina, posición confort, plan síntomas",
                        "Nada, es electiva",
                        "Insistir cirugía",
                        "Solo oxígeno"
                    ],
                    correct: 0,
                    feedback: "Plan integral síntomas: oxígeno confort, morfina si precisa, medidas no farmacológicas."
                }, {
                    aspect: "espiritual",
                    icon: "🙏",
                    question: "Desean ceremonia bendición antes de decidir. ¿Respuesta?",
                    options: [
                        "Es pérdida tiempo",
                        "Facilitar capellán, ceremonia, no presionar tiempo",
                        "Solo si deciden rápido",
                        "Primero decidir, después ritual"
                    ],
                    correct: 1,
                    feedback: "Facilitar ritual espiritual, no presionar tiempos, respetar proceso."
                }, {
                    aspect: "psicologico",
                    icon: "🧠",
                    question: "Conflicto pareja: él cirugía, ella cuidados paliativos. ¿Mediar?",
                    options: [
                        "Que decidan solos",
                        "Sesiones counseling, explorar valores, información objetiva, tiempo",
                        "Imponer decisión médica",
                        "Mayoría familia decide"
                    ],
                    correct: 1,
                    feedback: "Counseling para explorar valores, información objetiva, tiempo para consenso."
                }, {
                    aspect: "social",
                    icon: "👥",
                    question: "Hermanos pequeños, abuelos sobrepasados. ¿Coordinación?",
                    options: [
                        "No es prioritario",
                        "Trabajo social: cuidado hermanos, apoyo abuelos, red familiar",
                        "Familia debe arreglarse",
                        "Solo cuidar paciente"
                    ],
                    correct: 1,
                    feedback: "Trabajo social integral: cuidado hermanos, apoyo abuelos, fortalecer red."
                }]
            }],
            advanced: [{
                id: "mission_a_1",
                title: "Conflicto ético complejo familia-equipo",
                description: "Neonato encefalopatía severa, familia demanda tratamiento máximo, equipo considera fútil.",
                scenario: "Tras semanas deliberación, posiciones irreconciliables. Tensión escalando.",
                questions: [{
                    aspect: "sintomas",
                    icon: "💊",
                    question: "Convulsiones refractarias, sufrimiento evidente. ¿Manejo ético?",
                    options: [
                        "Tratamiento máximo aunque fútil",
                        "Retirar todo sin consentimiento",
                        "Manejo síntomas óptimo mientras se busca resolución ética",
                        "Transferir a otra institución"
                    ],
                    correct: 2,
                    feedback: "Manejo síntomas óptimo prioritario mientras se resuelve conflicto ético."
                }, {
                    aspect: "espiritual",
                    icon: "🙏",
                    question: "Creencias religiosas familiares opuestas a recomendación médica. ¿Abordar?",
                    options: [
                        "Convencer cambiar creencias",
                        "Ignorar aspecto religioso",
                        "Explorar creencias, involucrar líder religioso, buscar compatibilidad",
                        "Imponer ciencia sobre religión"
                    ],
                    correct: 2,
                    feedback: "Explorar creencias profundamente, involucrar líder religioso, buscar puntos compatibles."
                }, {
                    aspect: "psicologico",
                    icon: "🧠",
                    question: "Familia acusa equipo de 'querer matar'. ¿Respuesta psicológica?",
                    options: [
                        "Defenderse de acusación",
                        "Explorar miedos subyacentes, validar dolor, clarificar intenciones",
                        "Amenazar con retirada",
                        "Ignorar comentario"
                    ],
                    correct: 1,
                    feedback: "Explorar miedos profundos, validar dolor emocional, clarificar intenciones benéficas."
                }, {
                    aspect: "social",
                    icon: "👥",
                    question: "Medios comunicación se interesan por caso. ¿Manejo social?",
                    options: [
                        "Dar información libremente",
                        "Protocolo comunicación, confidencialidad, apoyo familia",
                        "Negar todo acceso",
                        "Culpar familia por filtración"
                    ],
                    correct: 1,
                    feedback: "Protocolo comunicación estricto, mantener confidencialidad, apoyar familia en presión mediática."
                }]
            }]
        };

        // Levels Configuration
        const levelsConfig = {
            beginner: {
                id: 1,
                name: "Principiante",
                icon: "🍼",
                color: "#A8D5E2",
                description: "Conceptos básicos, definiciones, principios éticos y comunicación",
                unlock_requirement: null,
                next_level_requirement: 0.7
            },
            intermediate: {
                id: 2,
                name: "Intermedio",
                icon: "🌿",
                color: "#B4D7B4",
                description: "Aspectos clínicos, toma de decisiones, manejo de síntomas, apoyo familiar",
                unlock_requirement: 0.7,
                next_level_requirement: 0.7
            },
            advanced: {
                id: 3,
                name: "Avanzado",
                icon: "🌈",
                color: "#F4C4D0",
                description: "Dilemas éticos complejos, coordinación interdisciplinar, casos reales",
                unlock_requirement: 0.7,
                next_level_requirement: null
            }
        };

        // Initialize Application
        function initApp() {
            console.log('Inicializando PERINATAL QUEST...');
            loadGameState();

            // CORRECCIÓN CRÍTICA: Asegurar que SIEMPRE iniciemos en HOME
            gameState.currentView = 'home';

            // Asegurar que el modal está oculto al inicio
            const modal = document.getElementById('protocol-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            }

            ensureHomeView();
            console.log('Aplicación iniciada correctamente en HOME');
        }

        // Save game state to localStorage
        function saveGameState() {
            try {
                const stateToSave = {
                    ...gameState,
                    questionsData: questionsData
                };
                const gameStateJSON = JSON.stringify(stateToSave);
                const gameStateVariables = {
                    gameStateData: stateToSave
                };
                window.gameStateStore = gameStateVariables;
            } catch (error) {
                console.log('Could not save game state:', error);
            }
        }

        // Load game state from localStorage
        function loadGameState() {
            try {
                if (window.gameStateStore && window.gameStateStore.gameStateData) {
                    const savedState = window.gameStateStore.gameStateData;
                    gameState = {
                        ...gameState,
                        ...savedState
                    };
                    // IMPORTANTE: Siempre forzar a HOME al inicializar
                    gameState.currentView = 'home';
                    if (savedState.questionsData) {
                        Object.assign(questionsData, savedState.questionsData);
                    }
                    console.log('Estado del juego cargado, forzando vista HOME');
                } else {
                    console.log('No hay estado previo guardado, iniciando desde cero');
                }
            } catch (error) {
                console.log('Could not load game state:', error);
                // En caso de error, asegurar que estamos en HOME
                gameState.currentView = 'home';
            }
        }

        // Navigation Functions
        function showView(viewId) {
            console.log(`Mostrando vista: ${viewId}`);

            // CORRECCIÓN: Lista de todas las vistas incluyendo protocol-modal
            const allViews = ['home-view', 'levels-view', 'quiz-view', 'mission-view', 'achievements-view', 'admin-view', 'resources-view', 'protocol-modal', 'summary-view', 'unlock-view', 'unlock-quiz-view'];

            // Ocultar todas las vistas
            allViews.forEach(id => {
                const view = document.getElementById(id);
                if (view) {
                    view.classList.add('hidden');
                    // Log específico para protocol-modal
                    if (id === 'protocol-modal') {
                        console.log('Protocol modal oculto en showView');
                    }
                }
            });

            // Mostrar la vista solicitada
            const targetView = document.getElementById(viewId);
            if (targetView) {
                targetView.classList.remove('hidden');
                gameState.currentView = viewId.replace('-view', '').replace('-modal', '');
                console.log(`Vista ${viewId} mostrada correctamente`);
                saveGameState();
            } else {
                console.error(`Vista ${viewId} no encontrada, volviendo a HOME`);
                showHome();
            }
        }

        function showResources() {
            console.log('Navegando a recursos');
            gameState.currentView = 'resources';

            // Asegurarse de que el modal está cerrado
            const modal = document.getElementById('protocol-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            }

            showView('resources-view');
        }

        function showProtocol() {
            console.log('Abriendo protocolo');
            const modal = document.getElementById('protocol-modal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex'; // Importante: mostrar como flex
            }
        }

        function closeProtocol() {
            console.log('Cerrando protocolo');
            const modal = document.getElementById('protocol-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none'; // Importante: ocultar completamente
            }
            return false; // Prevenir comportamiento por defecto
        }

        function downloadProtocol() {
            alert('📥 Simulando descarga del protocolo en PDF...');
        }

        function showHome() {
            console.log('Navegando a HOME');
            gameState.currentView = 'home';
            showView('home-view');
        }

        function showLevels() {
            console.log('Navegando a selección de niveles');
            gameState.currentView = 'levels';
            showView('levels-view');
            updateLevelsDisplay();
            updatePointsDisplay();
        }

        function showQuiz(levelKey) {
            console.log(`Iniciando quiz del nivel: ${levelKey}`);
            gameState.currentLevel = levelKey;
            gameState.currentQuestionIndex = 0;
            gameState.sessionErrors = [];
            gameState.missionUnlocked = false;
            gameState.currentView = 'quiz';

            // Get all questions for the level
            const allLevelQuestions = questionsData[levelKey] || [];

            // Filter out already answered questions by ID
            const answeredIds = gameState.user.answeredQuestions.map(q => q.id || q.question);
            const unansweredQuestions = allLevelQuestions.filter(q =>
                !answeredIds.includes(q.id) && !answeredIds.includes(q.question)
            );

            if (unansweredQuestions.length === 0) {
                alert('¡Has completado todas las preguntas de este nivel! ¡Excelente trabajo!');
                showLevels();
                return;
            }

            // Shuffle unanswered questions
            gameState.currentQuestions = shuffleArray([...unansweredQuestions]);

            showView('quiz-view');
            updateQuizHeader();
            displayQuestion();
        }

        function showAchievements() {
            console.log('Navegando a logros');
            gameState.currentView = 'achievements';
            showView('achievements-view');
            updateAchievementsDisplay();
            // Mostrar u ocultar el botón de seguir aprendiendo según el progreso
            const learnBtn = document.getElementById('learn-more-btn');
            if (learnBtn) {
                // Comprobar si existe al menos una medalla pendiente con preguntas de desbloqueo
                let pendingMedal = false;
                medalsData.forEach(medal => {
                    if (!gameState.user.medals.includes(medal.id) && unlockPools[medal.id]) {
                        pendingMedal = true;
                    }
                });
                if (pendingMedal) {
                    // Activar el botón: eliminar estilos de opacidad/ocultamiento y habilitarlo
                    learnBtn.disabled = false;
                    learnBtn.classList.remove('hidden');
                    learnBtn.classList.remove('opacity-50');
                } else {
                    // Desactivar el botón y atenuar su aspecto cuando no haya nada por desbloquear
                    learnBtn.disabled = true;
                    learnBtn.classList.add('opacity-50');
                }
            }
        }

        function showAdmin() {
            // Simple password protection
            const password = prompt("Contraseña de administrador:");
            if (password === "admin2024") {
                console.log('Navegando a panel admin');
                gameState.currentView = 'admin';
                showView('admin-view');
                updateQuestionsList();
            } else {
                alert("Contraseña incorrecta");
            }
        }

        function showSummary() {
            showView('summary-view');
            updateSummaryDisplay();
        }

        function exitQuiz() {
            const confirm = window.confirm("¿Estás seguro de que quieres salir del quiz? Tu progreso se guardará.");
            if (confirm) {
                saveGameState();
                showLevels();
            }
        }

        // Update Display Functions
        function updateLevelsDisplay() {
            const container = document.getElementById('levels-container');
            container.innerHTML = '';

            const levels = ['beginner', 'intermediate', 'advanced'];
            levels.forEach((levelKey, index) => {
                const level = levelsConfig[levelKey];
                const isUnlocked = gameState.user.levelsUnlocked.includes(level.id);
                const progress = gameState.user.progress[levelKey];

                // Calculate available questions (15 per level)
                const totalQuestionsInLevel = questionsData[levelKey]?.length || 15;
                const answeredInLevel = gameState.user.answeredQuestions.filter(q => q.level === levelKey).length;
                const completedMissions = gameState.user.completedMissions?.filter(id => {
                    const levelMissions = clinicalMissions[levelKey] || [];
                    return levelMissions.some(m => m.id === id);
                }).length || 0;

                const levelCard = document.createElement('div');
                levelCard.className = `card level-card ${levelKey} ${!isUnlocked ? 'locked' : ''}`;

                const unlockRequirement = level.unlock_requirement ?
                    `Requiere ${Math.round(level.unlock_requirement * 100)}% del nivel anterior` :
                    'Disponible';

                levelCard.innerHTML = `
                    <div class="text-center">
                        <div class="level-icon">${isUnlocked ? level.icon : '🔒'}</div>
                        <h3>${level.name}</h3>
                        <p class="text-sm mb-4">${level.description}</p>
                        <div class="progress-bar mb-4">
                            <div class="progress-fill" style="width: ${progress.percentage}%"></div>
                        </div>
                        <div class="text-sm mb-4">
                            <p>📝 ${answeredInLevel}/${totalQuestionsInLevel} preguntas</p>
                            <p>🏥 ${completedMissions}/5 misiones clínicas</p>
                            <p class="text-xs opacity-75">${unlockRequirement}</p>
                        </div>
                        <button class="btn ${isUnlocked ? 'btn-primary' : 'btn-secondary'} btn-full"
                                 ${!isUnlocked ? 'disabled' : ''}
                                 onclick="${isUnlocked ? `showQuiz('${levelKey}')` : ''}">
                            ${isUnlocked ? (answeredInLevel > 0 ? 'CONTINUAR' : 'EMPEZAR') : 'BLOQUEADO'}
                        </button>
                    </div>
                `;

                container.appendChild(levelCard);
            });
        }

        function updatePointsDisplay() {
            document.getElementById('total-points-display').textContent = gameState.user.totalPoints;

            // Calculate global progress
            const totalQuestions = Object.values(gameState.user.progress).reduce((sum, level) => sum + level.total, 0);
            const totalCorrect = Object.values(gameState.user.progress).reduce((sum, level) => sum + level.correct, 0);
            const globalProgress = totalQuestions > 0 ? (totalCorrect / totalQuestions) * 100 : 0;

            document.getElementById('global-progress').style.width = `${globalProgress}%`;
        }

        function updateQuizHeader() {
            // Permitir nivel de repaso sin configuración en levelsConfig
            let level = levelsConfig[gameState.currentLevel];
            if (!level) {
                // Nivel de repaso o modo personalizado
                level = {
                    icon: '🔁',
                    name: 'Repaso'
                };
            }
            document.getElementById('current-level-icon').textContent = level.icon;
            document.getElementById('current-level-name').textContent = level.name;
            document.getElementById('points-display').textContent = `⭐ ${gameState.user.totalPoints} puntos`;

            updateQuizProgress();
        }

        function updateQuizProgress() {
            const current = gameState.currentQuestionIndex + 1;
            const total = gameState.currentQuestions.length;
            document.getElementById('question-counter').textContent = `Pregunta ${current} de ${total}`;

            const progress = (gameState.currentQuestionIndex / total) * 100;
            document.getElementById('quiz-progress').style.width = `${progress}%`;
        }

        function displayQuestion() {
            const question = gameState.currentQuestions[gameState.currentQuestionIndex];
            if (!question) {
                // No more questions, show summary
                showSummary();
                return;
            }
            // Preparar la pregunta barajando opciones y alargando incorrectas
            prepareQuestion(question);

            const container = document.getElementById('question-container');
            container.innerHTML = `
                <div class="badge badge-primary mb-4">${getCategoryDisplayName(question.category)}</div>
                <h3 class="mb-6">${question.question}</h3>
                <div class="options-container">
                    ${question.displayOptions.map((option, index) => `
                        <button class="option-button" onclick="selectAnswer(${index})" id="option-${index}">
                            ${String.fromCharCode(65 + index)}. ${option}
                        </button>
                    `).join('')}
                </div>
            `;

            // Hide feedback
            document.getElementById('feedback-container').classList.add('hidden');
        }

        function selectAnswer(selectedIndex) {
            const question = gameState.currentQuestions[gameState.currentQuestionIndex];
            // Comparar con el índice correcto tras el barajado
            const isCorrect = selectedIndex === question.displayCorrectIndex;

            // Disable all option buttons
            document.querySelectorAll('.option-button').forEach(btn => {
                btn.disabled = true;
                btn.style.cursor = 'default';
            });

            // Highlight selected and correct answers
            document.getElementById(`option-${selectedIndex}`).classList.add('selected');
            document.getElementById(`option-${question.displayCorrectIndex}`).classList.add('correct');

            if (!isCorrect) {
                document.getElementById(`option-${selectedIndex}`).classList.add('incorrect');
                // Track error for summary
                gameState.sessionErrors.push({
                    question: question.question,
                    selectedAnswer: question.displayOptions[selectedIndex],
                    correctAnswer: question.displayOptions[question.displayCorrectIndex],
                    explanation: question.explanation
                });
            }

            // Update user progress
            updateUserProgress(question, isCorrect);

            // Show feedback
            showFeedback(question, isCorrect);

            // Actualizar racha de respuestas correctas
            if (isCorrect) {
                gameState.user.currentStreak++;
            } else {
                gameState.user.currentStreak = 0;
            }

            /*
             * Desbloquear misiones clínicas cada 5 preguntas respondidas (independientemente de si
             * fueron correctas). Para cada nivel se pueden completar hasta 3 misiones. Cuando
             * se cumple el múltiplo de 5 (5ª, 10ª, 15ª pregunta) y no hay una misión pendiente
             * (missionUnlocked = false), se muestra una misión aleatoria disponible del nivel.
             */
            const questionNumber = gameState.currentQuestionIndex + 1;
            const completedMissionIds = gameState.user.completedMissions || [];
            const levelMissions = clinicalMissions[gameState.currentLevel] || [];
            const levelMissionIds = levelMissions.map(m => m.id);
            const completedCountInLevel = levelMissionIds.filter(id => completedMissionIds.includes(id)).length;
            if (questionNumber % 5 === 0 && !gameState.missionUnlocked && completedCountInLevel < 3) {
                // Marcar la misión como desbloqueada para evitar que se dispare de nuevo hasta completarla
                gameState.missionUnlocked = true;
                setTimeout(() => {
                    showMission();
                }, 2000);
                return;
            }

            // Auto-advance after delay
            setTimeout(() => {
                nextQuestion();
            }, 3000);
        }

        function showFeedback(question, isCorrect) {
            const container = document.getElementById('feedback-container');
            const motivationalMessage = motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)];

            // Determinar la respuesta correcta según si se ha preparado la pregunta
            const correctAnswer = (question.displayOptions && question.displayCorrectIndex !== undefined) ?
                question.displayOptions[question.displayCorrectIndex] :
                question.options[question.correct];

            if (isCorrect) {
                container.innerHTML = `
                    <div class="feedback-card feedback-correct">
                        <h4>¡Excelente! ${motivationalMessage}</h4>
                        <p>${question.explanation}</p>
                        <div class="animation-points">+10 puntos ⭐</div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="feedback-card feedback-incorrect">
                        <h4>Oportunidad de aprender</h4>
                        <p><strong>Respuesta correcta:</strong> ${correctAnswer}</p>
                        <p>${question.explanation}</p>
                    </div>
                `;
            }

            container.classList.remove('hidden');

            // Check for new medals
            checkForNewMedals(question, isCorrect);
        }

        function updateUserProgress(question, isCorrect) {
            // Garantizar que exista un objeto de progreso para el nivel actual. Si el nivel
            // no se encuentra (por ejemplo, en modo de repaso 'review'), se crea una
            // entrada temporal para evitar errores. Esto permite almacenar estadísticas
            // sin bloquear la aplicación en modos personalizados.
            if (!gameState.user.progress[gameState.currentLevel]) {
                gameState.user.progress[gameState.currentLevel] = {
                    total: 0,
                    correct: 0,
                    percentage: 0
                };
            }
            const levelProgress = gameState.user.progress[gameState.currentLevel];
            // Incrementar totales
            levelProgress.total++;
            if (isCorrect) {
                levelProgress.correct++;
                gameState.user.totalPoints += 10;
            }
            levelProgress.percentage = (levelProgress.correct / levelProgress.total) * 100;

            // Gestionar desbloqueo de niveles solo para niveles definidos en levelsConfig
            if (levelsConfig[gameState.currentLevel] && levelProgress.percentage >= 70) {
                const currentLevelId = levelsConfig[gameState.currentLevel].id;
                const nextLevelId = currentLevelId + 1;
                if (nextLevelId <= 3 && !gameState.user.levelsUnlocked.includes(nextLevelId)) {
                    gameState.user.levelsUnlocked.push(nextLevelId);
                    // Mostrar notificación de desbloqueo con un retraso para evitar solapamientos
                    setTimeout(() => {
                        alert(`🎉 ¡Nuevo nivel desbloqueado! Ya puedes acceder al nivel ${nextLevelId}.`);
                    }, 1000);
                }
            }

            // Registrar la pregunta respondida para evitar repeticiones y permitir análisis
            gameState.user.answeredQuestions.push({
                id: question.id,
                question: question.question,
                category: question.category,
                correct: isCorrect,
                level: gameState.currentLevel
            });

            saveGameState();
        }

        function checkForNewMedals(question, isCorrect) {
            if (!isCorrect) return;

            medalsData.forEach(medal => {
                if (gameState.user.medals.includes(medal.id)) return;

                let earned = false;

                if (medal.requirement === "complete_beginner") {
                    earned = gameState.user.progress.beginner.percentage >= 70;
                } else if (medal.requirement === "complete_all_levels") {
                    earned = gameState.user.progress.beginner.percentage >= 70 &&
                        gameState.user.progress.intermediate.percentage >= 70 &&
                        gameState.user.progress.advanced.percentage >= 70;
                } else if (medal.requirement === "mission_sintomas_2") {
                    earned = (gameState.user.missionAspectProgress?.sintomas || 0) >= 2;
                } else if (medal.requirement === "mission_espiritual_3") {
                    earned = (gameState.user.missionAspectProgress?.espiritual || 0) >= 3;
                } else if (medal.requirement === "mission_psicologico_3") {
                    earned = (gameState.user.missionAspectProgress?.psicologico || 0) >= 3;
                } else if (typeof medal.requirement === 'number' && medal.category) {
                    const categoryCount = gameState.user.answeredQuestions.filter(
                        q => q.category === medal.category && q.correct
                    ).length;
                    earned = categoryCount >= medal.requirement;
                }

                if (earned) {
                    gameState.user.medals.push(medal.id);
                    showMedalUnlock(medal);
                }
            });
        }

        function showMedalUnlock(medal) {
            // Create medal unlock notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 2rem;
                border-radius: 1rem;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                text-align: center;
                z-index: 9999;
                animation: medalUnlock 0.8s ease-out;
            `;

            notification.innerHTML = `
                <div class="text-6xl mb-4">${medal.icon}</div>
                <h3 class="font-bold mb-2">¡Nueva Medalla!</h3>
                <p class="font-semibold">${medal.name}</p>
                <p class="text-sm">${medal.description}</p>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function nextQuestion() {
            gameState.currentQuestionIndex++;
            updateQuizProgress();
            displayQuestion();
        }

        function showMission() {
            // Select random available mission from current level
            const levelMissions = clinicalMissions[gameState.currentLevel] || [];
            const completedMissionIds = gameState.user.completedMissions || [];
            const availableMissions = levelMissions.filter(m => !completedMissionIds.includes(m.id));

            if (availableMissions.length === 0) {
                alert('¡Has completado todas las misiones de este nivel!');
                nextQuestion();
                return;
            }

            const mission = availableMissions[Math.floor(Math.random() * availableMissions.length)];
            gameState.currentMission = mission;
            gameState.currentMissionQuestionIndex = 0;
            gameState.missionAnswers = [];

            showView('mission-view');
            displayMissionContent();
        }

        function displayMissionContent() {
            const mission = gameState.currentMission;
            const container = document.getElementById('mission-content');

            container.innerHTML = `
                <div class="card">
                    <h3 class="mb-4">${mission.title}</h3>
                    <p class="mb-4">${mission.description}</p>
                    <div class="scenario-text">
                        <strong>Escenario:</strong><br>
                        ${mission.scenario}
                    </div>
                </div>

                <div class="progress-bar mb-4">
                    <div class="progress-fill" style="width: ${(gameState.currentMissionQuestionIndex / mission.questions.length) * 100}%"></div>
                </div>

                <div class="text-center mb-4">
                    <span class="badge badge-primary">Pregunta ${gameState.currentMissionQuestionIndex + 1} de ${mission.questions.length}</span>
                </div>

                <div id="current-mission-question">
                    ${displayCurrentMissionQuestion()}
                </div>
            `;
        }

        function displayCurrentMissionQuestion() {
            const mission = gameState.currentMission;
            const currentQ = mission.questions[gameState.currentMissionQuestionIndex];

            if (!currentQ) {
                return completeMissionSummary();
            }

            return `
                <div class="decision-card">
                    <div class="flex items-center mb-4">
                        <span class="text-2xl mr-2">${currentQ.icon}</span>
                        <h4>Pregunta sobre ${getAspectDisplayName(currentQ.aspect)}</h4>
                    </div>
                    <h4 class="mb-4">${currentQ.question}</h4>
                    ${currentQ.options.map((option, optIndex) => `
                        <button class="option-button" onclick="selectMissionAnswer(${optIndex})" id="mission-option-${optIndex}">
                            ${String.fromCharCode(65 + optIndex)}. ${option}
                        </button>
                    `).join('')}
                    <div id="mission-feedback" class="hidden mt-4"></div>
                </div>
            `;
        }

        function getAspectDisplayName(aspect) {
            const names = {
                'sintomas': 'Manejo de Síntomas',
                'espiritual': 'Plano Espiritual',
                'psicologico': 'Plano Psicológico',
                'social': 'Plano Social'
            };
            return names[aspect] || aspect;
        }

        function selectMissionAnswer(optionIndex) {
            const mission = gameState.currentMission;
            const currentQ = mission.questions[gameState.currentMissionQuestionIndex];
            const isCorrect = optionIndex === currentQ.correct;

            // Disable all buttons
            document.querySelectorAll('#current-mission-question .option-button').forEach(btn => {
                btn.disabled = true;
            });

            // Show correct/incorrect styling
            document.getElementById(`mission-option-${optionIndex}`).classList.add('selected');
            document.getElementById(`mission-option-${currentQ.correct}`).classList.add('correct');

            if (!isCorrect) {
                document.getElementById(`mission-option-${optionIndex}`).classList.add('incorrect');
            }

            // Show feedback
            const feedbackDiv = document.getElementById('mission-feedback');
            feedbackDiv.classList.remove('hidden');
            feedbackDiv.className = `feedback-card ${isCorrect ? 'feedback-correct' : 'feedback-incorrect'}`;
            feedbackDiv.innerHTML = `<p>${currentQ.feedback}</p>`;

            // Store answer
            gameState.missionAnswers.push({
                aspect: currentQ.aspect,
                correct: isCorrect,
                question: currentQ.question
            });

            // CORRECCIÓN CRÍTICA: Auto advance after delay
            setTimeout(() => {
                gameState.currentMissionQuestionIndex++;

                // Si hemos completado todas las preguntas, completar misión
                if (gameState.currentMissionQuestionIndex >= mission.questions.length) {
                    // Mostrar resumen antes de pasar a la siguiente pregunta del quiz
                    const container = document.getElementById('mission-content');
                    container.innerHTML = completeMissionSummary();
                    document.getElementById('mission-complete-button').style.display = 'block';

                    // Llamada a completeMission al hacer click en el botón de CONTINUAR
                } else {
                    // Si quedan preguntas, mostrar la siguiente
                    displayMissionContent();
                }
            }, 2000);
        }

        function completeMissionSummary() {
            const correctCount = gameState.missionAnswers.filter(a => a.correct).length;
            const totalCount = gameState.missionAnswers.length;

            return `
                <div class="card text-center">
                    <h3 class="mb-4">¡Misión Completada!</h3>
                    <p class="mb-4">Resultado: ${correctCount}/${totalCount} respuestas correctas</p>
                    <div class="mb-4">
                        ${gameState.missionAnswers.map(answer => `
                            <div class="badge ${answer.correct ? 'badge-success' : 'badge-pink'} mb-2">
                                ${answer.aspect}: ${answer.correct ? '✓' : '✗'}
                            </div>
                        `).join('')}
                    </div>
                    <p class="text-sm mb-4">¡+50 puntos de bonificación por completar la misión!</p>
                </div>
            `;
        }


        function completeMission() {
            // Ocultar el botón de completar misión
            document.getElementById('mission-complete-button').style.display = 'none';

            // Award points
            gameState.user.totalPoints += 50;

            // Mark mission as completed
            if (!gameState.user.completedMissions) {
                gameState.user.completedMissions = [];
            }
            gameState.user.completedMissions.push(gameState.currentMission.id);

            // Check for medals based on mission aspects
            const correctAspects = gameState.missionAnswers.filter(a => a.correct);

            // Update mission progress tracking
            correctAspects.forEach(answer => {
                if (!gameState.user.missionAspectProgress) {
                    gameState.user.missionAspectProgress = {};
                }
                if (!gameState.user.missionAspectProgress[answer.aspect]) {
                    gameState.user.missionAspectProgress[answer.aspect] = 0;
                }
                gameState.user.missionAspectProgress[answer.aspect]++;
            });

            // Check for aspect-specific medals
            checkMissionMedals();

            saveGameState();

            /*
             * Una vez completada la misión debemos volver al flujo normal del cuestionario.
             * Además de mostrar la vista del quiz, es importante restablecer la bandera
             * `missionUnlocked` para que futuras rachas de 5 respuestas correctas vuelvan
             * a desbloquear nuevas misiones. También reiniciamos la racha actual
             * (`currentStreak`) para que el usuario tenga que acumular de nuevo 5 aciertos
             * antes de acceder a otra misión. Por último actualizamos la cabecera y
             * avanzamos a la siguiente pregunta.
             */
            // Reset mission flags and streak
            gameState.missionUnlocked = false;
            gameState.user.currentStreak = 0;

            // Mostrar nuevamente la vista del quiz
            showView('quiz-view');
            // Actualizar cabecera del quiz para reflejar los puntos y nivel actuales
            updateQuizHeader();
            // Avanzar a la siguiente pregunta del cuestionario
            nextQuestion();
        }

        function checkMissionMedals() {
            // Check for spiritual support medal
            if (gameState.user.missionAspectProgress?.espiritual >= 3 && !gameState.user.medals.includes('espiritual')) {
                gameState.user.medals.push('espiritual');
                showMedalUnlock({
                    id: 'espiritual',
                    name: 'Apoyo Espiritual',
                    icon: '🙏',
                    description: '3 respuestas correctas en plano espiritual'
                });
            }

            // Check for psychological support medal
            if (gameState.user.missionAspectProgress?.psicologico >= 3 && !gameState.user.medals.includes('psicologico')) {
                gameState.user.medals.push('psicologico');
                showMedalUnlock({
                    id: 'psicologico',
                    name: 'Apoyo Psicológico',
                    icon: '🧠',
                    description: '3 respuestas correctas en plano psicológico'
                });
            }

            // Check for symptom management medal based on missions
            if (gameState.user.missionAspectProgress?.sintomas >= 2 && !gameState.user.medals.includes('sintomas')) {
                gameState.user.medals.push('sintomas');
                showMedalUnlock(medalsData.find(m => m.id === 'sintomas'));
            }
        }

        function updateAchievementsDisplay() {
            document.getElementById('achievements-points').textContent = gameState.user.totalPoints;
            document.getElementById('current-streak').textContent = gameState.user.currentStreak;

            // Display medals
            const medalsContainer = document.getElementById('medals-container');
            medalsContainer.innerHTML = '';

            medalsData.forEach(medal => {
                const isEarned = gameState.user.medals.includes(medal.id);
                const medalCard = document.createElement('div');
                medalCard.className = `medal-card ${isEarned ? 'earned' : 'locked'}`;

                medalCard.innerHTML = `
                    <div class="medal-icon">${medal.icon}</div>
                    <h4 class="font-semibold">${medal.name}</h4>
                    <p class="text-sm">${medal.description}</p>
                    ${isEarned ? '<div class="badge badge-success mt-2">Conseguida</div>' : '<div class="badge mt-2">Bloqueada</div>'}
                `;

                medalsContainer.appendChild(medalCard);
            });

            // Update statistics with new data structure
            const totalAnswered = gameState.user.answeredQuestions.length;
            const correctAnswered = gameState.user.answeredQuestions.filter(q => q.correct).length;
            const successRate = totalAnswered > 0 ? Math.round((correctAnswered / totalAnswered) * 100) : 0;
            const completedMissions = gameState.user.completedMissions?.length || 0;

            document.getElementById('total-answered').textContent = `${totalAnswered}/45`;
            document.getElementById('success-rate').textContent = `${successRate}%`;
            document.getElementById('missions-completed').textContent = `${completedMissions}/15`;

            // Current level based on highest unlocked
            const currentLevelName = Object.keys(levelsConfig).find(key =>
                levelsConfig[key].id === Math.max(...gameState.user.levelsUnlocked)
            );
            document.getElementById('current-level-stats').textContent =
                currentLevelName ? levelsConfig[currentLevelName].name : 'Principiante';
        }

        function updateSummaryDisplay() {
            const container = document.getElementById('session-summary');

            // Calcular total de preguntas contestadas utilizando todas las preguntas cargadas para la sesión actual.
            const correctCount = gameState.currentQuestions.length - gameState.sessionErrors.length;
            const totalCount = gameState.currentQuestions.length;
            const percentage = totalCount > 0 ? Math.round((correctCount / totalCount) * 100) : 0;

            if (gameState.sessionErrors.length === 0) {
                container.innerHTML = `
                    <h3 class="text-center mb-4">¡Sesión perfecta!</h3>
                    <p class="text-center">Respondiste ${totalCount} preguntas sin errores. ¡Excelente trabajo!</p>
                    <div class="text-center mt-4">
                        <div class="badge badge-success">Tasa de acierto: 100%</div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <h3 class="mb-4">Resumen de la Sesión</h3>
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="text-center">
                            <div class="badge badge-success">${correctCount} correctas</div>
                        </div>
                        <div class="text-center">
                            <div class="badge badge-pink">${gameState.sessionErrors.length} incorrectas</div>
                        </div>
                        <div class="text-center">
                            <div class="badge badge-primary">${percentage}% acierto</div>
                        </div>
                    </div>

                                        <h4 class="mb-4">Preguntas para revisar:</h4>
                    ${gameState.sessionErrors.map(error => `
                            <div class="mb-4 p-4" style="background-color: var(--color-gray-soft); border-radius: var(--radius-base);">
                            <h5 class="font-semibold mb-2">${error.question}</h5>
                            <p><strong>Tu respuesta:</strong> ${error.selectedAnswer}</p>
                            <p><strong>Respuesta correcta:</strong> ${error.correctAnswer}</p>
                            <p class="text-sm mt-2">💡 ${error.explanation}</p>
                        </div>
                    `).join('')}
                `;
            }
        }

        function startReviewMode() {
            // Find weak categories
            const categoryStats = {};
            gameState.user.answeredQuestions.forEach(q => {
                if (!categoryStats[q.category]) {
                    categoryStats[q.category] = {
                        correct: 0,
                        total: 0
                    };
                }
                categoryStats[q.category].total++;
                if (q.correct) categoryStats[q.category].correct++;
            });

            // Find categories with < 70% success rate
            const weakCategories = Object.keys(categoryStats).filter(cat => {
                const stats = categoryStats[cat];
                return stats.total >= 3 && (stats.correct / stats.total) < 0.7;
            });

            if (weakCategories.length === 0) {
                alert("¡No tienes áreas débiles! Continúa con el siguiente nivel.");
                showLevels();
                return;
            }

            // Create focused quiz from all levels
            const focusedQuestions = [];
            Object.values(questionsData).forEach(levelQuestions => {
                levelQuestions.forEach(question => {
                    if (weakCategories.includes(question.category)) {
                        focusedQuestions.push(question);
                    }
                });
            });

            if (focusedQuestions.length > 0) {
                gameState.currentQuestions = shuffleArray(focusedQuestions).slice(0, 10);
                gameState.currentQuestionIndex = 0;
                gameState.currentLevel = 'review';
                showView('quiz-view');
                updateQuizHeader();
                displayQuestion();
            } else {
                alert("No hay preguntas disponibles para revisar.");
                showLevels();
            }
        }

        function practiceWeakAreas() {
            /*
             * Modo de práctica de preguntas falladas: recupera todas las preguntas
             * que el usuario ha respondido incorrectamente en la sesión actual y
             * vuelve a presentarlas de forma consecutiva. Esto se basa en
             * `gameState.sessionErrors`, que almacena las preguntas falladas
             * durante el último quiz. No mezclamos errores de sesiones pasadas
             * para asegurar un repaso enfocado en las áreas débiles recientes.
             */
            const errors = gameState.sessionErrors || [];
            if (!errors.length) {
                alert('¡No tienes preguntas falladas para repasar!');
                showLevels();
                return;
            }
            const wrongQuestions = [];
            errors.forEach(err => {
                // Buscar la pregunta original en todos los niveles usando el texto de la pregunta.
                let found = null;
                Object.keys(questionsData).forEach(levelKey => {
                    if (found) return;
                    const list = questionsData[levelKey] || [];
                    const match = list.find(q => q.question.trim() === err.question.trim());
                    if (match) {
                        found = match;
                    }
                });
                if (found) {
                    wrongQuestions.push(found);
                }
            });
            if (!wrongQuestions.length) {
                alert('No se encontraron preguntas para repasar.');
                showLevels();
                return;
            }
            // Establecer el modo de repaso con las preguntas falladas
            gameState.currentQuestions = wrongQuestions;
            gameState.currentQuestionIndex = 0;
            gameState.currentLevel = 'review';
            showView('quiz-view');
            updateQuizHeader();
            displayQuestion();
        }

        // Admin Functions
        function updateQuestionsList() {
            const container = document.getElementById('questions-list');
            container.innerHTML = '';

            Object.keys(questionsData).forEach(level => {
                questionsData[level].forEach((question, index) => {
                    const questionItem = document.createElement('div');
                    questionItem.className = 'question-item';
                    questionItem.innerHTML = `
                        <div>
                            <strong>${level} - ${question.category}:</strong><br>
                            <span class="text-sm">${question.id}</span><br>
                            ${question.question.substring(0, 60)}...
                        </div>
                        <button class="btn btn-sm" onclick="deleteQuestion('${level}', ${index})"
                                style="background-color: var(--color-error); color: white; font-size: 12px;">
                            Eliminar
                        </button>
                    `;
                    container.appendChild(questionItem);
                });
            });
        }

        function deleteQuestion(level, index) {
            if (confirm('¿Estás seguro de que quieres eliminar esta pregunta?')) {
                questionsData[level].splice(index, 1);
                saveGameState();
                updateQuestionsList();
            }
        }

        // Form submission for adding questions
        document.addEventListener('DOMContentLoaded', function() {
            const questionForm = document.getElementById('question-form');
            if (questionForm) {
                questionForm.addEventListener('submit', function(e) {
                    e.preventDefault();

                    const level = document.getElementById('question-level').value;
                    const category = document.getElementById('question-category').value;
                    const questionText = document.getElementById('question-text').value;
                    const options = [
                        document.getElementById('option-a').value,
                        document.getElementById('option-b').value,
                        document.getElementById('option-c').value,
                        document.getElementById('option-d').value
                    ];
                    const correct = parseInt(document.querySelector('input[name="correct-answer"]:checked').value);
                    const explanation = document.getElementById('question-explanation').value;

                    // Generate unique ID
                    const questionId = `${level.charAt(0)}_${category.substring(0, 4)}_${Date.now()}`;

                    // Create new question object
                    const newQuestion = {
                        id: questionId,
                        question: questionText,
                        options: options,
                        correct: correct,
                        explanation: explanation,
                        category: category
                    };

                    // Add to questions data
                    if (!questionsData[level]) {
                        questionsData[level] = [];
                    }

                    questionsData[level].push(newQuestion);

                    // Save and update display
                    saveGameState();
                    updateQuestionsList();

                    // Reset form
                    questionForm.reset();
                    alert('Pregunta añadida correctamente!');
                });
            }
        });

        // Utility Functions
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            // Devolver el nuevo arreglo barajado
            return newArray;
        }

        /**
         * Prepara una pregunta para su visualización.
         * - Alarga las opciones incorrectas añadiendo frases neutras para evitar sesgos por longitud.
         * - Baraja las opciones y ajusta el índice de la respuesta correcta.
         * Almacena las opciones barajadas en question.displayOptions y el índice correcto en question.displayCorrectIndex.
         */
        function prepareQuestion(question) {
            // Si ya tiene opciones preparadas, no repetir
            if (question.displayOptions && question.displayCorrectIndex !== undefined) return;
            const fillerPhrases = [
                " teniendo en cuenta el apoyo psicológico, social y espiritual",
                " considerando las necesidades de la familia y el entorno",
                " garantizando la comunicación y soporte continuo",
                " fomentando la participación de los padres y del equipo"
            ];
            // Construir nuevas opciones con relleno en incorrectas
            const options = question.options.map((opt, idx) => {
                if (idx === question.correct) {
                    return opt;
                } else {
                    const filler = fillerPhrases[Math.floor(Math.random() * fillerPhrases.length)];
                    return opt + filler;
                }
            });
            // Emparejar cada opción con su índice original
            const paired = options.map((opt, index) => ({
                opt,
                originalIndex: index
            }));
            // Barajar el array emparejado
            for (let i = paired.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [paired[i], paired[j]] = [paired[j], paired[i]];
            }
            // Asignar opciones barajadas y el nuevo índice correcto
            question.displayOptions = paired.map(p => p.opt);
            question.displayCorrectIndex = paired.findIndex(p => p.originalIndex === question.correct);
        }

        /**
         * Muestra la vista de desbloqueo de medallas.
         * Solo las medallas no obtenidas con preguntas disponibles aparecerán para desbloquear.
         */
        function showUnlockView() {
            console.log('Navegando a desbloqueo de medallas');
            gameState.currentView = 'unlock';
            showView('unlock-view');
            const container = document.getElementById('unlock-options');
            container.innerHTML = '';
            let hasLocked = false;
            medalsData.forEach(medal => {
                // Solo medallas no obtenidas y que tengan preguntas asociadas
                if (!gameState.user.medals.includes(medal.id) && unlockPools[medal.id]) {
                    hasLocked = true;
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div class="flex flex-col items-center">
                            <div class="text-3xl mb-2">${medal.icon}</div>
                            <h4>${medal.name}</h4>
                            <p class="text-sm mb-2">${medal.description}</p>
                            <button class="btn btn-primary mt-2" onclick="startUnlockQuiz('${medal.id}')">Desbloquear</button>
                        </div>
                    `;
                    container.appendChild(card);
                }
            });
            if (!hasLocked) {
                container.innerHTML = '<p>🎉 Ya has desbloqueado todas las medallas. ¡Enhorabuena!</p>';
            }
        }

        /**
         * Inicia un quiz de desbloqueo para una medalla específica.
         * Selecciona 5 preguntas aleatorias del pool correspondiente.
         */
        function startUnlockQuiz(medalId) {
            const pool = unlockPools[medalId] || [];
            // Separar preguntas de caso y de opción múltiple
            let caseQuestions = pool.filter(q => q.isCase);
            let mcqQuestions = pool.filter(q => !q.isCase);

            /*
             * Asegurar que haya suficientes preguntas de opción múltiple (al menos 5).
             * Algunos pools pueden contener menos de 5 MCQs, lo que impediría
             * iniciar el quiz de desbloqueo. Para evitar errores y permitir
             * desbloquear todas las medallas, duplicamos preguntas existentes
             * hasta alcanzar el mínimo requerido. Las preguntas duplicadas
             * reciben un identificador único para evitar colisiones.
             */
            if (mcqQuestions.length < 5 && mcqQuestions.length > 0) {
                const originalLength = mcqQuestions.length;
                let duplicateCount = 0;
                // Crear duplicados hasta alcanzar 5
                while (mcqQuestions.length < 5) {
                    const idx = duplicateCount % originalLength;
                    const baseQ = mcqQuestions[idx];
                    // Clonar pregunta y asignar id único
                    const clone = Object.assign({}, baseQ, { id: baseQ.id + '_dup' + duplicateCount });
                    mcqQuestions.push(clone);
                    duplicateCount++;
                }
            }

            // Si no hay preguntas en absoluto, mostrar error y salir
            if (mcqQuestions.length === 0) {
                alert('No hay preguntas disponibles para desbloquear esta medalla.');
                return;
            }

            gameState.unlockMode = true;
            gameState.unlockMedal = medalId;
            // Seleccionar MCQs y caso clínico si existen
            let numberOfMcq = 5;
            let selectedCase = [];
            if (caseQuestions.length > 0) {
                selectedCase = shuffleArray([...caseQuestions]).slice(0, 1);
            } else {
                // Si no hay casos clínicos, usar una MCQ adicional
                numberOfMcq = 6;
            }
            const selectedMcq = shuffleArray([...mcqQuestions]).slice(0, numberOfMcq);
            gameState.unlockQuestions = [...selectedMcq, ...selectedCase];
            gameState.unlockQuestionIndex = 0;
            gameState.unlockCorrectCount = 0;
            showView('unlock-quiz-view');
            displayUnlockQuestion();
        }

        /**
         * Muestra la pregunta actual del quiz de desbloqueo.
         */
        function displayUnlockQuestion() {
            const q = gameState.unlockQuestions[gameState.unlockQuestionIndex];
            if (!q) {
                completeUnlockQuiz();
                return;
            }
            prepareQuestion(q);
            const container = document.getElementById('unlock-question-container');
            container.innerHTML = `
                <div class="badge badge-primary mb-4">${getCategoryDisplayName(q.category)}</div>
                <h3 class="mb-6">${q.question}</h3>
                <div class="options-container">
                    ${q.displayOptions.map((opt, i) => `
                        <button class="option-button" onclick="selectUnlockAnswer(${i})" id="unlock-option-${i}">
                            ${String.fromCharCode(65 + i)}. ${opt}
                        </button>
                    `).join('')}
                </div>
            `;
            // Ocultar feedback
            document.getElementById('unlock-feedback-container').classList.add('hidden');
            // Actualizar progreso
            const progress = (gameState.unlockQuestionIndex / gameState.unlockQuestions.length) * 100;
            document.getElementById('unlock-quiz-progress').style.width = `${progress}%`;
            document.getElementById('unlock-quiz-counter').textContent = `Pregunta ${gameState.unlockQuestionIndex + 1} de ${gameState.unlockQuestions.length}`;
        }

        /**
         * Gestiona la selección de respuesta en el quiz de desbloqueo.
         */
        function selectUnlockAnswer(selectedIndex) {
            const q = gameState.unlockQuestions[gameState.unlockQuestionIndex];
            const isCorrect = selectedIndex === q.displayCorrectIndex;
            // Desactivar botones
            document.querySelectorAll('#unlock-question-container .option-button').forEach(btn => {
                btn.disabled = true;
                btn.style.cursor = 'default';
            });
            // Resaltar
            document.getElementById(`unlock-option-${selectedIndex}`).classList.add('selected');
            document.getElementById(`unlock-option-${q.displayCorrectIndex}`).classList.add('correct');
            if (!isCorrect) {
                document.getElementById(`unlock-option-${selectedIndex}`).classList.add('incorrect');
            } else {
                gameState.unlockCorrectCount++;
            }
            // Mostrar feedback
            const feedbackContainer = document.getElementById('unlock-feedback-container');
            if (isCorrect) {
                feedbackContainer.innerHTML = `
                    <div class="feedback-card feedback-correct">
                        <h4>¡Bien hecho!</h4>
                        <p>${q.explanation}</p>
                    </div>
                `;
            } else {
                feedbackContainer.innerHTML = `
                    <div class="feedback-card feedback-incorrect">
                        <h4>Respuesta correcta:</h4>
                        <p>${q.displayOptions[q.displayCorrectIndex]}</p>
                        <p>${q.explanation}</p>
                    </div>
                `;
            }
            feedbackContainer.classList.remove('hidden');
            // Avanzar a la siguiente pregunta después de un breve retraso
            setTimeout(() => {
                gameState.unlockQuestionIndex++;
                displayUnlockQuestion();
            }, 3000);
        }

        /**
         * Completa el quiz de desbloqueo y concede la medalla si se alcanza el umbral.
         */
        function completeUnlockQuiz() {
            const passed = gameState.unlockCorrectCount >= gameState.unlockThreshold;
            const medalId = gameState.unlockMedal;
            if (passed) {
                if (!gameState.user.medals.includes(medalId)) {
                    gameState.user.medals.push(medalId);
                }
                const medal = medalsData.find(m => m.id === medalId);
                alert(`¡Has desbloqueado la medalla ${medal.name}!`);
            } else {
                alert('No alcanzaste la puntuación necesaria para desbloquear la medalla. Inténtalo de nuevo.');
            }
            saveGameState();
            // Restablecer estado de desbloqueo
            gameState.unlockMode = false;
            gameState.unlockMedal = null;
            gameState.unlockQuestions = [];
            gameState.unlockQuestionIndex = 0;
            gameState.unlockCorrectCount = 0;
            showUnlockView();
        }

        /**
         * Sale del quiz de desbloqueo sin otorgar medalla.
         */
        function exitUnlockQuiz() {
            // Restablecer estado
            gameState.unlockMode = false;
            gameState.unlockMedal = null;
            gameState.unlockQuestions = [];
            gameState.unlockQuestionIndex = 0;
            gameState.unlockCorrectCount = 0;
            showUnlockView();
        }

        function getCategoryDisplayName(category) {
            const displayNames = {
                fundamentos: 'Fundamentos',
                comunicacion: 'Comunicación',
                etica: 'Ética',
                manejo_sintomas: 'Manejo de Síntomas',
                toma_decisiones: 'Toma de Decisiones',
                apoyo_familiar: 'Apoyo Familiar',
                casos_complejos: 'Casos Complejos',
                dilemas_eticos: 'Dilemas Éticos',
                duelo: 'Duelo',
                empatia: 'Empatía Clínica',
                sintomas: 'Manejo Sintomático',
                espiritual: 'Apoyo Espiritual',
                psicologico: 'Apoyo Psicológico',
                maestro: 'Maestro CPP'
            };
            return displayNames[category] || category;
        }

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM cargado, inicializando aplicación...');
            initApp();
        });

        // Función para asegurar inicialización correcta
        function ensureHomeView() {
            console.log('Asegurando que estamos en la vista HOME...');

            // Ocultar todas las vistas
            const views = ['levels-view', 'quiz-view', 'mission-view', 'achievements-view', 'admin-view', 'resources-view', 'summary-view', 'unlock-view', 'unlock-quiz-view'];
            views.forEach(viewId => {
                const view = document.getElementById(viewId);
                if (view) {
                    view.classList.add('hidden');
                }
            });

            // Ocultar específicamente el modal del protocolo
            const modal = document.getElementById('protocol-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            }

            // Mostrar solo la vista home
            const homeView = document.getElementById('home-view');
            if (homeView) {
                homeView.classList.remove('hidden');
                console.log('Vista HOME mostrada correctamente');
            }
        }

        // Eliminado el manejo duplicado de DOMContentLoaded y fallback redundante.
    </script>
    <script>
        (function() {
            const SAFE_DELAY = 1200;

            function attachMissionGuards() {
                const container = document.getElementById('current-mission-question');
                if (!container) return;
                container.querySelectorAll('.option-button').forEach(btn => {
                    if (btn.dataset._fixBound) return;
                    btn.dataset._fixBound = "1";
                    btn.addEventListener('click', () => {
                        try {
                            const gs = window.gameState || {};
                            const m = gs.currentMission || {};
                            const idxBefore = Number.isInteger(gs.currentMissionQuestionIndex) ? gs.currentMissionQuestionIndex : 0;
                            const total = Array.isArray(m.questions) ? m.questions.length : 4;
                            setTimeout(() => {
                                const gs2 = window.gameState || {};
                                const m2 = gs2.currentMission || {};
                                const idxAfter = Number.isInteger(gs2.currentMissionQuestionIndex) ? gs2.currentMissionQuestionIndex : idxBefore;
                                const isLast = (idxBefore >= total - 1) || (idxAfter >= total - 1);
                                // Si es la última pregunta, mostramos el botón de completar misión.
                                if (isLast) {
                                    const button = document.getElementById('mission-complete-button');
                                    if (button) {
                                        button.style.display = 'block';
                                    }
                                }
                            }, SAFE_DELAY);
                        } catch (e) {
                            console.warn('mission hot-fix error', e);
                        }
                    }, {
                        once: false
                    });
                });
            }
            const mo = new MutationObserver(attachMissionGuards);
            mo.observe(document.body, {
                childList: true,
                subtree: true
            });
            attachMissionGuards();
        })();
    </script>

</body>

</html>